<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>Django介绍 | VIP</title>
  
  <meta name="HandheldFriendly" content="True">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="shortcut icon" href="/">
  <link rel="alternate" href="/atom.xml" title="VIP">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <link rel="shortcut icon" href="">
  <link rel="icon" href="">
  
  <link href="https://fonts.googleapis.com/css?family=Ubuntu|Ubuntu+Mono" rel="stylesheet">
  
  <!-- <link href="https://cdn.bootcss.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"> -->
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
  <link href="//cdn.bootcss.com/node-waves/0.7.5/waves.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/style.css">
  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>
  
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?xxx";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
  
</head>
</html>
<body>
    <div id="loading-bar-wrapper">
  <div id="loading-bar" class="pure"></div>
</div>

    <script>setLoadingBarProgress(20)</script>
    <header class="l_header pure">
	<div class="wrapper">
		<div class="nav-main container container--flex">
			<a class="logo flat-box" href="/">VIP</a>
				<div class="menu">
					<ul class="h-list">
            
    					
    						<li>
    							<a class="nav flat-box" href="https://www.ice5.vip/">
    								<i class="fas fa-home fa-fw"></i>&nbsp;主页
  								</a>
  							</li>
        			
    						<li>
    							<a class="nav flat-box" href="https://www.ice5.vip/">
    								<i class="fas fa-flask fa-fw"></i>&nbsp;项目
  								</a>
  							</li>
        			
    						<li>
    							<a class="nav flat-box" href="/">
    								<i class="fas fa-rss fa-fw"></i>&nbsp;博客
  								</a>
  							</li>
        			
    						<li>
    							<a class="nav flat-box" href="/archives/">
    								<i class="fas fa-archive fa-fw"></i>&nbsp;归档
  								</a>
  							</li>
        			
    						<li>
    							<a class="nav flat-box" href="https://www.ice5.vip/">
    								<i class="fas fa-user fa-fw"></i>&nbsp;关于
  								</a>
  							</li>
        			
        		
					</ul>
					<div class="underline"></div>
				</div>

			
				<div class="m_search">
					<form name="searchform" class="form u-search-form">
						<input type="text" class="input u-search-input" placeholder="Search">
						<span class="icon"><i class="fas fa-search fa-fw"></i></span>
					</form>
				</div>
			
			<ul class="switcher h-list">
				
					<li class="s-search"><a class="fas fa-search fa-fw" href="javascript:void(0)"></a></li>
				
				<li class="s-menu"><a class="fas fa-bars fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>

		<div class="nav-sub container container--flex">
			<a class="logo flat-box"></a>
			<ul class="switcher h-list">
				<li class="s-comment"><a class="fas fa-comments fa-fw" href="javascript:void(0)"></a></li>
				<li class="s-top"><a class="fas fa-arrow-up fa-fw" href="javascript:void(0)"></a></li>
				<li class="s-toc"><a class="fas fa-list fa-fw" href="javascript:void(0)"></a></li>
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone">
		<nav>
      <ul>
          
              
                  <li>
										<a class="nav  flat-box" href="https://www.ice5.vip/">
											<i class="fas fa-home fa-fw"></i>&nbsp;主页
										</a>
                  </li>
              
                  <li>
										<a class="nav  flat-box" href="https://www.ice5.vip/">
											<i class="fas fa-flask fa-fw"></i>&nbsp;项目
										</a>
                  </li>
              
                  <li>
										<a class="nav  flat-box" href="/">
											<i class="fas fa-rss fa-fw"></i>&nbsp;博客
										</a>
                  </li>
              
                  <li>
										<a class="nav  flat-box" href="/archives/">
											<i class="fas fa-archive fa-fw"></i>&nbsp;归档
										</a>
                  </li>
              
                  <li>
										<a class="nav  flat-box" href="https://www.ice5.vip/">
											<i class="fas fa-user fa-fw"></i>&nbsp;关于
										</a>
                  </li>
              
       
      </ul>
		</nav>
	</aside>

    <script>setLoadingBarProgress(40);</script>
    <div class="l_body">
    <div class='container clearfix'>
        <div class='l_main'>
            <article id="post-Django" class="post white-box article-type-post" itemscope="" itemprop="blogPost">
    <section class="meta">
        
            <h1 class="title">Django介绍</h1>
        
        <time class="time">
            <i class="fas fa-calendar-alt fa-fw" aria-hidden="true"></i>
            2018-12-02
        </time>
        
          <div class="browse busuanzi"><i class="fas fa-eye fa-fw" aria-hidden="true"></i>
            <span id="busuanzi_value_page_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
          </div>
        

        
    
    <div class="cats">
        <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>
        <a class="categories" href="/categories/Django/">Django</a>
    </div>


    </section>

    <section class="article typo">

        <div class="article-entry" itemprop="articleBody">
            <h1 id="一、Django-简介"><a href="#一、Django-简介" class="headerlink" title="一、Django 简介"></a>一、Django 简介</h1><p>Web框架（Web framework）是一种开发框架，用来支持动态网站、网络应用和网络服务的开发。这大多数的web框架提供了一套开发和部署网站的方式，也为web行为提供了一套通用的方法。</p>
<a id="more"></a>
<h2 id="1-Http-协议特性"><a href="#1-Http-协议特性" class="headerlink" title="1.Http 协议特性"></a>1.Http 协议特性</h2><ul>
<li>TCP/IP协议之上的应用层协议</li>
<li>基于Request-Response模式</li>
<li>无状态保存</li>
<li>无连接</li>
</ul>
<h2 id="2-MVC和MTV"><a href="#2-MVC和MTV" class="headerlink" title="2.MVC和MTV"></a>2.MVC和MTV</h2><h3 id="①-MVC"><a href="#①-MVC" class="headerlink" title="① MVC"></a>① MVC</h3><ul>
<li>M：Model（存取数据）</li>
<li>V：View（取到数据展示给用户）</li>
<li>C：Controller（分配工作给M和V）</li>
</ul>
<h3 id="②-MTV"><a href="#②-MTV" class="headerlink" title="② MTV"></a>② MTV</h3><ul>
<li>M：Model（存取数据）</li>
<li>T：Template（取到数据展示给用户）</li>
<li>V：View（从M处取数据，返回给T）</li>
<li>URL控制器</li>
</ul>
<h2 id="3-Django请求生命周期"><a href="#3-Django请求生命周期" class="headerlink" title="3.Django请求生命周期"></a>3.Django请求生命周期</h2><p>Browser — Web服务器（wsgi协议）— Middleware — URL路由 —View === ①从DataBase取数据；②将数据渲染至template</p>
<h1 id="二、路由"><a href="#二、路由" class="headerlink" title="二、路由"></a>二、路由</h1><h2 id="1-定义"><a href="#1-定义" class="headerlink" title="1.定义"></a>1.定义</h2><p>本质是<strong>URL与要为该URL调用的视图函数之间的映射表</strong> </p>
<h2 id="2-简单路由配置"><a href="#2-简单路由配置" class="headerlink" title="2.简单路由配置"></a>2.简单路由配置</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line">urlpatterns = [</span><br><span class="line">     url(<span class="string">r"pattern"</span>,views.视图函数,&#123;key:value&#125;,name=别名),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">注意:urlpatterns从上至下逐行匹配,成功不再往下执行</span><br></pre></td></tr></table></figure>
<h2 id="3-有名分组"><a href="#3-有名分组" class="headerlink" title="3.有名分组"></a>3.有名分组</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">	url(<span class="string">"index/(?P&lt;num&gt;pattern)"</span>,views.index),</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request,num=<span class="number">1</span>)</span>:</span></span><br><span class="line">    print(num)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br><span class="line">    </span><br><span class="line">注意：捕获的值作为关键字参数而不是位置参数传递给视图函数</span><br></pre></td></tr></table></figure>
<h2 id="4-无名分组"><a href="#4-无名分组" class="headerlink" title="4. 无名分组"></a>4. 无名分组</h2><h2 id="5-路由分发"><a href="#5-路由分发" class="headerlink" title="5.路由分发"></a>5.路由分发</h2><p>① 主URL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from django.conf.urls import url,include</span><br><span class="line"># from django.urls import path,re_path,include  // 2.+版本</span><br><span class="line">from app01 import views</span><br><span class="line">from app01 import urls</span><br><span class="line">urlpatterns = [ </span><br><span class="line">　　path(&apos;app01/&apos;,include(&apos;app01.urls&apos;)),</span><br><span class="line">　　path(&apos;app01/&apos;, include(urls)),</span><br><span class="line">]</span><br><span class="line">注意:include() 括号中建议写app01.urls的方式,而不是直接写urls</span><br></pre></td></tr></table></figure>
<p>② app01中的URL</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path  // <span class="number">2.</span>+版本</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r"pattern"</span>,views.视图函数,&#123;key:value&#125;,name=别名),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="6-路由反向解析"><a href="#6-路由反向解析" class="headerlink" title="6.路由反向解析"></a>6.路由反向解析</h2><ul>
<li>应用:获得URL 的最终形式，用于嵌入到生成的内容中（视图中和显示给用户的URL等）或者用于处理服务器端的导航（重定向等）。</li>
</ul>
<p>①urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path,re_path</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    re_path(<span class="string">r"有名分组"</span>,views.视图函数,&#123;key:value&#125;,name=别名),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>②html代码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;% url &quot;别名&quot; 参数1 参数2 ... %&#125;</span><br></pre></td></tr></table></figure>
<p>③视图函数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">url=reverse(&apos;test&apos;)</span><br><span class="line">url=reverse(&apos;test&apos;,args=(10,20))</span><br></pre></td></tr></table></figure>
<h2 id="7-名称空间"><a href="#7-名称空间" class="headerlink" title="7.名称空间"></a>7.名称空间</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">由于name没有作用域，Django在反解URL时，会在项目全局顺序搜索，当查找到第一个name指定URL时，立即返回</span><br><span class="line">在开发项目时，会经常使用name属性反解出URL，当不小心在不同的app的urls中定义相同的name时，可能会导致URL反解错误，为了避免这种事情发生，引入了命名空间。</span><br></pre></td></tr></table></figure>
<ul>
<li>解决方式：在路由分发时，指定名称空间</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">urls.py</span><br><span class="line">urlpatterns = [</span><br><span class="line">	url(r&apos;app01/&apos;,include(&apos;app01.urls&apos;,namespace=&apos;app01&apos;)),</span><br><span class="line">	url(r&apos;app02/&apos;,include(&apos;app02.urls&apos;,namespace=&apos;app02&apos;))，</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">视图函数</span><br><span class="line">url=reverse(&apos;app02:index&apos;)</span><br><span class="line">url2=reverse(&apos;app01:index&apos;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">模板</span><br><span class="line">&lt;a href=&quot;&#123;% url &apos;app02:index&apos;%&#125;&quot;&gt;LOL NB&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<h2 id="8-Django-2-版的path"><a href="#8-Django-2-版的path" class="headerlink" title="8.Django 2.+版的path"></a>8.Django 2.+版的path</h2><p>①模板</p>
<figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">from django.urls import path  </span><br><span class="line">from app01 import views  </span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(r'index/&lt;int:year&gt;/&lt;slug&gt;/', views.视图函数),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>②基本规则</p>
<ul>
<li>使用尖括号(<code>&lt;&gt;</code>)从url中捕获值。</li>
<li>捕获值中可以包含一个转化器类型（converter type），比如使用 <code>&lt;int:name&gt;</code> 捕获一个整数变量。若果没有转化器，将匹配任何字符串，当然也包括了 <code>/</code> 字符。</li>
<li>无需添加前导斜杠。</li>
</ul>
<p>③path转换器</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">str,匹配除了路径分隔符（/）之外的非空字符串，这是默认的形式</span><br><span class="line">int,匹配正整数，包含<span class="number">0</span></span><br><span class="line">slug,匹配字母、数字以及横杠、下划线组成的字符串</span><br><span class="line">uuid,匹配格式化的uuid，如 <span class="number">075194</span>d3<span class="number">-6885</span><span class="number">-417</span>e-a8a8<span class="number">-6</span>c931e272f00</span><br><span class="line">path,匹配任何非空字符串，包含了路径分隔符（/）（不能用？）</span><br></pre></td></tr></table></figure>
<p>④自定义注册转换器</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">对于一些复杂或者复用的需要，可以定义自己的转化器。转化器是一个类或接口，它的要求有三点：</span><br><span class="line"></span><br><span class="line">  regex 类属性，字符串类型</span><br><span class="line">  to_python(self, value) 方法，value是由类属性 regex 所匹配到的字符串，返回具体的Python变量值，以供Django传递到对应的视图函数中。</span><br><span class="line">  to_url(self, value) 方法，和 to_python 相反，value是一个具体的Python变量值，返回其字符串，通常用于url反向引用。</span><br></pre></td></tr></table></figure>
<ul>
<li>自定义文件</li>
</ul>
<p>app01/Myconverter.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyConverter</span>:</span>  </span><br><span class="line">    regex = <span class="string">"pattern"</span>  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_python</span><span class="params">(self, value)</span>:</span>  </span><br><span class="line">        <span class="keyword">return</span> int(value)  </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">to_url</span><span class="params">(self, value)</span>:</span>  </span><br><span class="line">        <span class="keyword">return</span> <span class="string">'%04d'</span> % value</span><br></pre></td></tr></table></figure>
<p>urls.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> register_converter, path  </span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> converters, views  </span><br><span class="line">①注册</span><br><span class="line">register_converter(converters.MyConverter, <span class="string">'type'</span>) </span><br><span class="line">②使用</span><br><span class="line">urlpatterns = [  </span><br><span class="line">    path(<span class="string">'articles/&lt;type:year&gt;/'</span>, views.year_archive),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h1 id="三、视图"><a href="#三、视图" class="headerlink" title="三、视图"></a>三、视图</h1><h2 id="1-三剑客"><a href="#1-三剑客" class="headerlink" title="1.三剑客"></a>1.三剑客</h2><figure class="highlight django"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">from django.shortcuts import render, HttpResponse, redirect</span><br><span class="line"></span><br><span class="line">视图层，熟练掌握两个对象即可：请求对象(request)和响应对象(HttpResponse)</span><br></pre></td></tr></table></figure>
<h2 id="2-HttpRequest对象"><a href="#2-HttpRequest对象" class="headerlink" title="2. HttpRequest对象"></a>2. HttpRequest对象</h2><ul>
<li>Django将请求报文中的请求行、首部信息、内容主体封装成 HttpRequest 类中的属性。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">request.GET</span><br><span class="line">	类似于字典的对象,包含 HTTP GET 的所有参数;QueryDict</span><br><span class="line">	</span><br><span class="line">request.POST</span><br><span class="line">	类似于字典的对象,如果请求中包含表单数据,则将这些数据封装成 QueryDict 对象</span><br><span class="line">注意：键值对的值是多个的时候,比如checkbox类型的input标签，select标签，需要用： request.POST.getlist(<span class="string">"hobby"</span>)</span><br><span class="line">	</span><br><span class="line">request.body</span><br><span class="line">	一个字符串，代表请求报文的主体。在处理非 HTTP 形式的报文时非常有用，例如：二进制图片、XML,Json等。但是，如果要处理表单数据的时候，推荐还是使用 HttpRequest.POST </span><br><span class="line">	</span><br><span class="line">request.path</span><br><span class="line">	一个字符串，表示请求的路径组件（不含域名）。</span><br><span class="line">　　例如：<span class="string">"/music/bands/the_beatles/"</span></span><br><span class="line">　　</span><br><span class="line">request.method</span><br><span class="line">	一个字符串，表示请求使用的HTTP 方法。必须使用大写。</span><br><span class="line">	</span><br><span class="line">request.FILES</span><br><span class="line">	一个类似于字典的对象，包含所有的上传文件信息。FILES 中的每个键为&lt;input type=<span class="string">"file"</span> name=<span class="string">""</span> &gt; 中的name，值则为对应的数据。</span><br><span class="line">　　 <span class="comment"># 注意，FILES 只有在请求的方法为POST 且提交的&lt;form&gt; 带有enctype="multipart/form-data" 的情况下才会包含数据。否则，FILES 将为一个空的类似于字典的对象。</span></span><br><span class="line">　　 </span><br><span class="line">request.COOKIES</span><br><span class="line">	一个标准的Python 字典，包含所有的cookie。键和值都为字符串。</span><br><span class="line">	</span><br><span class="line">request.session</span><br><span class="line">	一个既可读又可写的类似于字典的对象，表示当前的会话。只有当Django 启用会话的支持时才可用。</span><br><span class="line">--------------------------------------------------------</span><br><span class="line">request.encoding</span><br><span class="line">	一个字符串，表示提交的数据的编码方式（如果为 <span class="keyword">None</span> 则表示使用 DEFAULT_CHARSET 的设置，默认为 <span class="string">'utf-8'</span>）。</span><br><span class="line">    这个属性是可写的，你可以修改它来修改访问表单数据使用的编码。</span><br><span class="line">    接下来对属性的任何访问（例如从 GET 或 POST 中读取数据）将使用新的 encoding 值。</span><br><span class="line">    若你知道表单数据的编码不是 DEFAULT_CHARSET ，则使用它。</span><br><span class="line">    </span><br><span class="line">request.META</span><br><span class="line">	 　　一个标准的 Python 字典，包含所有的 HTTP 首部。具体的头部信息取决于客户端和服务器，下面是一些示例：</span><br><span class="line">　　取值：</span><br><span class="line"></span><br><span class="line">    CONTENT_LENGTH —— 请求的正文的长度（是一个字符串）。</span><br><span class="line">    CONTENT_TYPE —— 请求的正文的MIME 类型。</span><br><span class="line">    HTTP_ACCEPT —— 响应可接收的Content-Type。</span><br><span class="line">    HTTP_ACCEPT_ENCODING —— 响应可接收的编码。</span><br><span class="line">    HTTP_ACCEPT_LANGUAGE —— 响应可接收的语言。</span><br><span class="line">    HTTP_HOST —— 客服端发送的HTTP Host 头部。</span><br><span class="line">    HTTP_REFERER —— Referring 页面。</span><br><span class="line">    HTTP_USER_AGENT —— 客户端的user-agent 字符串。</span><br><span class="line">    QUERY_STRING —— 单个字符串形式的查询字符串（未解析过的形式）。</span><br><span class="line">    REMOTE_ADDR —— 客户端的IP 地址。</span><br><span class="line">    REMOTE_HOST —— 客户端的主机名。</span><br><span class="line">    REMOTE_USER —— 服务器认证后的用户。</span><br><span class="line">    REQUEST_METHOD —— 一个字符串，例如<span class="string">"GET"</span> 或<span class="string">"POST"</span>。</span><br><span class="line">    SERVER_NAME —— 服务器的主机名。</span><br><span class="line">    SERVER_PORT —— 服务器的端口（是一个字符串）。</span><br><span class="line"> 　　从上面可以看到，除 CONTENT_LENGTH 和 CONTENT_TYPE 之外，请求中的任何 HTTP 首部转换为 META 的键时，</span><br><span class="line">    都会将所有字母大写并将连接符替换为下划线最后加上 HTTP_  前缀。</span><br><span class="line">    所以，一个叫做 X-Bender 的头部将转换成 META 中的 HTTP_X_BENDER 键。</span><br><span class="line">    </span><br><span class="line">request.user(用户认证组件下使用)</span><br><span class="line">	一个 AUTH_USER_MODEL 类型的对象，表示当前登录的用户。</span><br><span class="line">	如果用户当前没有登录，user 将设置为 django.contrib.auth.models.AnonymousUser 的一个实例。可以通过 is_authenticated() 区分它们。</span><br></pre></td></tr></table></figure>
<ul>
<li>request常用方法</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">request.get_full_path()</span><br><span class="line">	返回 path，如果可以将加上查询字符串。</span><br><span class="line">	例如：<span class="string">"/music/bands/the_beatles/?print=true"</span></span><br><span class="line"></span><br><span class="line">request.path()</span><br><span class="line">	返回：/music/bands/the_beatles</span><br><span class="line">	</span><br><span class="line">request.is_ajax()</span><br><span class="line">	若请求是通过 XMLHttpRequest 发起的,则返回 <span class="keyword">True</span>,方法是检查 HTTP_X_REQUESTED_WITH 相应的首部是否是字符串<span class="string">'XMLHttpRequest'</span></span><br><span class="line">	大部分现代的 JavaScript 库都会发送这个头部。若自己编写的 XMLHttpRequest 调用（在浏览器端），你必须手工设置这个值来让 is_ajax() 可以工作。</span><br><span class="line">　　如果一个响应需要根据请求是否是通过AJAX 发起的，并且你正在使用某种形式的缓存例如Django 的 cache middleware，</span><br><span class="line">   你应该使用 vary_on_headers(<span class="string">'HTTP_X_REQUESTED_WITH'</span>) 装饰你的视图以让响应能够正确地缓存。</span><br></pre></td></tr></table></figure>
<h2 id="3-HttpResponse-对象"><a href="#3-HttpResponse-对象" class="headerlink" title="3.HttpResponse 对象"></a>3.HttpResponse 对象</h2><ul>
<li>响应三剑客</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">from django.shortcuts import render, HttpResponse, redirect</span><br></pre></td></tr></table></figure>
<ul>
<li>HttpResponse()</li>
</ul>
<p>括号内直接跟上字符串作为响应体</p>
<ul>
<li>render()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">render(request, template_name[, context]）</span><br><span class="line"></span><br><span class="line">     request： 用于生成响应的请求对象。</span><br><span class="line">     template_name：要使用的模板的完整名称，可选的参数</span><br><span class="line">     context：添加到模板上下文的一个字典。默认是一个空字典。如果字典中的某个值是可调用的，视图将在渲染模板之前调用它。</span><br><span class="line"></span><br><span class="line">render方法就是将一个模板页面中的模板语法进行渲染，最终渲染成一个html页面作为响应体</span><br></pre></td></tr></table></figure>
<ul>
<li>redirect()</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">跳转至指定的 URL</span><br></pre></td></tr></table></figure>
<ul>
<li>重定向301和302的异同点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">相同点：浏览器在拿到服务器返回的这个状态码后会自动跳转到一个新的URL地址</span><br><span class="line">不同点：</span><br><span class="line">	301表示旧地址A的资源已经被永久地移除了（该资源不可访问了），搜索引擎在抓取新内容的同时也将旧的网址交换为重定向之后的网址；</span><br><span class="line">	302表示旧地址A的资源还在（仍然可以访问），这个重定向只是临时地从旧地址A跳转到地址B，搜索引擎会抓取新的内容而保存旧的网址。 SEO302好于301</span><br><span class="line">	</span><br><span class="line">重定向原因：</span><br><span class="line">（1）网站调整（如改变网页目录结构）；</span><br><span class="line">（2）网页被移到一个新地址；</span><br><span class="line">（3）网页扩展名改变(如应用需要把.php改成.Html或.shtml)。</span><br><span class="line">    这种情况下，如果不做重定向，则用户收藏夹或搜索引擎数据库中旧地址只能让访问客户得到一个404页面错误信息，访问流量白白丧失；再者某些注册了多个域名的</span><br><span class="line">    网站，也需要通过重定向让访问这些域名的用户自动跳转到主站点等。</span><br></pre></td></tr></table></figure>
<h2 id="4-JsonResponse"><a href="#4-JsonResponse" class="headerlink" title="4.JsonResponse"></a>4.JsonResponse</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 第一种方式</span></span><br><span class="line"><span class="comment"># import json</span></span><br><span class="line"><span class="comment"># data=&#123;'name':'lqz','age':18&#125;</span></span><br><span class="line"><span class="comment"># data1=['lqz','egon']</span></span><br><span class="line"><span class="comment">#     return HttpResponse(json.dumps(data1))</span></span><br><span class="line"><span class="comment"># 第二种方式</span></span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> JsonResponse</span><br><span class="line">data = &#123;<span class="string">'name'</span>: <span class="string">'lqz'</span>, <span class="string">'age'</span>: <span class="number">18</span>&#125;</span><br><span class="line">data1 = [<span class="string">'lqz'</span>, <span class="string">'egon'</span>]</span><br><span class="line"><span class="keyword">return</span> JsonResponse(data)</span><br><span class="line"><span class="keyword">return</span> JsonResponse(data1,safe=<span class="keyword">False</span>)  <span class="comment"># safe=True(默认) 表示只有字典才可以被序列化</span></span><br><span class="line">向前端返回一个json格式字符串的两种方式</span><br></pre></td></tr></table></figure>
<h2 id="5-CBV和FBV"><a href="#5-CBV和FBV" class="headerlink" title="5.CBV和FBV"></a>5.CBV和FBV</h2><ul>
<li>CBV:Class base view —基于类的视图</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views <span class="keyword">import</span> View</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AddPublish</span><span class="params">(View)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        print(request)</span><br><span class="line">        print(args)</span><br><span class="line">        print(kwargs)</span><br><span class="line">        <span class="comment"># 可以写类似装饰器的东西，在前后加代码</span></span><br><span class="line">        obj=super().dispatch(request, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'index.html'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        request</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'post'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>FBV:Function base view 基于函数的视图</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"hi"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="6-简单文件上传"><a href="#6-简单文件上传" class="headerlink" title="6.简单文件上传"></a>6.简单文件上传</h2><ul>
<li>html 文件</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--不设置 enctype 属性，那么最终就会以 application/x-www-form-urlencoded 方式提交数据--&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"POST"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>上传<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>py 文件</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.files.uploadedfile <span class="keyword">import</span> InMemoryUploadedFile</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(request.FILES)</span><br><span class="line">    print(type(request.FILES.get(<span class="string">'file_name'</span>)))</span><br><span class="line">    file_name=request.FILES.get(<span class="string">'file_name'</span>).name</span><br><span class="line">        <span class="keyword">with</span> open(file_name,<span class="string">'wb'</span>)<span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> i <span class="keyword">in</span> request.FILES.get(<span class="string">'file_name'</span>).chunks():</span><br><span class="line">                f.write(i)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"Ok"</span>)</span><br></pre></td></tr></table></figure>
<h1 id="四、模板"><a href="#四、模板" class="headerlink" title="四、模板"></a>四、模板</h1><h2 id="1-template-html"><a href="#1-template-html" class="headerlink" title="1.template.html"></a>1.template.html</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; 写非逻辑代码 &#125;&#125;  ---变量</span><br><span class="line">&#123;% 写逻辑代码 %&#125;    ---标签---if/for/extract</span><br><span class="line"></span><br><span class="line">服务器传到前端的数据(data)如果是字典的取值方式(深度查询): data.字段</span><br></pre></td></tr></table></figure>
<h2 id="2-过滤器"><a href="#2-过滤器" class="headerlink" title="2.过滤器"></a>2.过滤器</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; obj | filter__name:param &#125;&#125;  变量名 | 过滤器名:参数</span><br><span class="line"></span><br><span class="line">&#123;&#123; obj | safe &#125;&#125;  告诉浏览器是安全的,可以直接进行渲染,不必转义</span><br><span class="line">	xss攻击：跨站脚本攻击</span><br><span class="line">	可以在视图函数里处理</span><br><span class="line">	from django.utils.safestring import mark_safe</span><br><span class="line">	obj=mark_safe(obj)</span><br><span class="line"></span><br><span class="line">&#123;&#123; value|default:"nothing" &#125;&#125; 变量是false或者为空,使用给定的默认值</span><br><span class="line">&#123;&#123; value|length &#125;&#125; 返回值的长度.它对字符串和列表都起作用</span><br><span class="line">&#123;&#123; value|filesizeformat &#125;&#125; 将值格式化为"人类可读的"文件尺寸</span><br><span class="line">&#123;&#123; value|date:"Y-m-d" &#125;&#125; 显示value的时间</span><br><span class="line">&#123;&#123; value|slice:"2:-1" &#125;&#125; 将value切分</span><br><span class="line">&#123;&#123; value|truncatechars:9 &#125;&#125; 如果字符串字符多于指定的字符数量,那么会被截断,截断的字符串将以可翻译的省略号序列（“...”）结尾</span><br><span class="line">&#123;&#123; value|truncatewords:2 &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">其他过滤器：https://www.cnblogs.com/liuqingzheng/articles/9509806.html</span><br></pre></td></tr></table></figure>
<h2 id="3-标签"><a href="#3-标签" class="headerlink" title="3.标签"></a>3.标签</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% empty %&#125; 只能在for循环当中使用</span><br><span class="line"></span><br><span class="line">//起别名</span><br><span class="line">&#123;% with total=business.employees.count %&#125;</span><br><span class="line">	&#123;&#123; total &#125;&#125; employee&#123;&#123; total|pluralize &#125;&#125;</span><br><span class="line">&#123;% endwith %&#125;</span><br><span class="line"></span><br><span class="line">跨站请求伪造保护</span><br><span class="line">&#123;% csrf_token%&#125;</span><br></pre></td></tr></table></figure>
<h2 id="4-自定义templatetags"><a href="#4-自定义templatetags" class="headerlink" title="4.自定义templatetags"></a>4.自定义templatetags</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">①在app01写创建templatetags目录(名字不可变动)</span><br><span class="line">②创建 my_tags.py 文件</span><br><span class="line">	<span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">	<span class="keyword">from</span> django.utils.safestring <span class="keyword">import</span> mark_safe</span><br><span class="line">	register=template.Library() //register 名字是固定的</span><br><span class="line"></span><br><span class="line">	// 自定义标签</span><br><span class="line">	// @register.simple_tag</span><br><span class="line">	// <span class="function"><span class="keyword">def</span> <span class="title">demo1</span><span class="params">(v1,v2)</span>:</span></span><br><span class="line">	// 	  <span class="keyword">return</span>  v1 * v2</span><br><span class="line"><span class="meta">	@register.simple_tag</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">my_input</span><span class="params">(id,arg)</span>:</span></span><br><span class="line">    	result = <span class="string">"&lt;input type='text'&gt;"</span> </span><br><span class="line">    	<span class="keyword">return</span> mark_safe(result)</span><br><span class="line">        </span><br><span class="line">	// 自定义过滤器</span><br><span class="line"><span class="meta">	@register.filter()</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">demo2</span><span class="params">(v1,v2)</span>:</span></span><br><span class="line">		<span class="keyword">return</span>  v1 * v2</span><br><span class="line">③在使用自定义simple_tag和filter的html文件中导入之前创建的 my_tags.py</span><br><span class="line">	&#123;% load my_tags %&#125;</span><br><span class="line">	&#123;&#123; num|demo2:<span class="number">2</span> &#125;&#125;</span><br><span class="line">	&#123;&#123; num|demo2:<span class="string">"[22,333,4444]"</span> &#125;&#125;</span><br><span class="line">	</span><br><span class="line">	&#123;% demo1 <span class="number">2</span> <span class="number">5</span> %&#125;  参数不限,但不能放在<span class="keyword">if</span> <span class="keyword">for</span>语句中</span><br><span class="line">	&#123;% demo1i num <span class="number">5</span> %&#125;</span><br></pre></td></tr></table></figure>
<p>​<br>    注意：在settings.py中的INSTALLED_APPS配置当前app,不然Django无法找到自定义的simple_tag</p>
<h2 id="5-模板导入和继承"><a href="#5-模板导入和继承" class="headerlink" title="5.模板导入和继承"></a>5.模板导入和继承</h2><p>①导入</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;% include 'template.html' %&#125;</span><br><span class="line"></span><br><span class="line">&#123;&#123; block.super &#125;&#125;  // 复用模板的 block 组件</span><br></pre></td></tr></table></figure>
<p>②继承</p>
<ul>
<li>模板 html 文件</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"style.css"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>&#123;% block title %&#125;My amazing site&#123;% endblock %&#125;<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"sidebar"</span>&gt;</span></span><br><span class="line">    &#123;% block sidebar %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/"</span>&gt;</span>Home<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/blog/"</span>&gt;</span>Blog<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">    &#123;% block content %&#125;&#123;% endblock %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">base.html 定义了一个可以用于两列排版页面的简单HTML骨架。block 标签定义了三个可以被子模版内容填充的block。block 告诉模版引擎： 子模版可能会覆盖掉模版中的这些位置。</span><br></pre></td></tr></table></figure>
<ul>
<li>子模板 html 文件</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&#123;% extends "base.html" %&#125;</span><br><span class="line"> </span><br><span class="line">&#123;% block title %&#125;My amazing blog&#123;% endblock %&#125;</span><br><span class="line"> </span><br><span class="line">&#123;% block content %&#125;</span><br><span class="line">&#123;% for entry in blog_entries %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">h2</span>&gt;</span>&#123;&#123; entry.title &#125;&#125;<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; entry.body &#125;&#125;<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">&#123;% endfor %&#125;</span><br><span class="line">&#123;% endblock %&#125;</span><br><span class="line"></span><br><span class="line">"子模版"的工作是用它们的内容填充空的blocks。</span><br><span class="line">extends 它告诉模版引擎，这个模版"继承"了另一个模版。当模版系统处理这个模版时,将定位父模板 base.html</span><br></pre></td></tr></table></figure>
<ul>
<li>使用继承的注意点</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在模版中使用 &#123;% extends %&#125; 标签，它必须是模版中的第一个标签。其他的任何情况下，模版继承都将无法工作</span><br><span class="line">base模版中设置越多的 &#123;% block %&#125; 标签越好</span><br><span class="line">当你在大量的模版中复制内容,可能意味着你应该把内容移动到父模版中的一个 &#123;% block %&#125; 中</span><br><span class="line">给 &#123;% endblock name %&#125; 标签一个 name,具有更高的可读性</span><br></pre></td></tr></table></figure>
<h2 id="6-静态文件相关"><a href="#6-静态文件相关" class="headerlink" title="6.静态文件相关"></a>6.静态文件相关</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% static "</span><span class="attr">images</span>/<span class="attr">hi.jpg</span>" %&#125;" <span class="attr">alt</span>=<span class="string">"Hi!"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>引用JS文件时使用 </li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"&#123;% static "</span><span class="attr">mytest.js</span>" %&#125;"&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>get_static_prefix </li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#123;% load static %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;% get_static_prefix %&#125;images/hi.jpg"</span> <span class="attr">alt</span>=<span class="string">"Hi!"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">or</span><br><span class="line"></span><br><span class="line">&#123;% load static %&#125;</span><br><span class="line">&#123;% get_static_prefix as STATIC_PREFIX %&#125;</span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; STATIC_PREFIX &#125;&#125;images/hi.jpg"</span> <span class="attr">alt</span>=<span class="string">"Hi!"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"&#123;&#123; STATIC_PREFIX &#125;&#125;images/hi2.jpg"</span> <span class="attr">alt</span>=<span class="string">"Hello!"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="7-inclusion-tag"><a href="#7-inclusion-tag" class="headerlink" title="7.inclusion_tag"></a>7.inclusion_tag</h2><ul>
<li>作用：返回 html 代码片段</li>
<li>templatetags / my_inclusion.py </li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> template</span><br><span class="line">register = template.Library()</span><br><span class="line"></span><br><span class="line"><span class="meta">@register.inclusion_tag('result.html')</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show_results</span><span class="params">(n)</span>:</span></span><br><span class="line">    n = <span class="number">1</span> <span class="keyword">if</span> n &lt; <span class="number">1</span> <span class="keyword">else</span> int(n)</span><br><span class="line">    data = [<span class="string">"第&#123;&#125;项"</span>.format(i) <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, n+<span class="number">1</span>)]</span><br><span class="line">    <span class="keyword">return</span> &#123;<span class="string">"data"</span>: data&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>templates / snippets / result.html </li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">  &#123;% for choice in data %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; choice &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">  &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>templates / index.html </li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"x-ua-compatible"</span> <span class="attr">content</span>=<span class="string">"IE=edge"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">title</span>&gt;</span>my_inclusion<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	&#123;% load my_inclusion %&#125;</span><br><span class="line">	&#123;% show_results 10 %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h1 id="五、模型-models-py"><a href="#五、模型-models-py" class="headerlink" title="五、模型(models.py)"></a>五、模型(models.py)</h1><ul>
<li>单表操作</li>
</ul>
<p>①创建表</p>
<p>②字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br></pre></td><td class="code"><pre><span class="line">AutoField(Field)</span><br><span class="line">        - int自增列，必须填入参数 primary_key=<span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">    BigAutoField(AutoField)</span><br><span class="line">        - bigint自增列，必须填入参数 primary_key=<span class="keyword">True</span></span><br><span class="line"></span><br><span class="line">        注：当model中如果没有自增列，则自动会创建一个列名为id的列</span><br><span class="line">        <span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">            <span class="comment"># 自动创建一个列名为id的且为自增的整数列</span></span><br><span class="line">            username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Group</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">            <span class="comment"># 自定义自增列</span></span><br><span class="line">            nid = models.AutoField(primary_key=<span class="keyword">True</span>)</span><br><span class="line">            name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line">    SmallIntegerField(IntegerField):</span><br><span class="line">        - 小整数 <span class="number">-32768</span> ～ <span class="number">32767</span></span><br><span class="line"></span><br><span class="line">    PositiveSmallIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</span><br><span class="line">        - 正小整数 <span class="number">0</span> ～ <span class="number">32767</span></span><br><span class="line">    IntegerField(Field)</span><br><span class="line">        - 整数列(有符号的) <span class="number">-2147483648</span> ～ <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">    PositiveIntegerField(PositiveIntegerRelDbTypeMixin, IntegerField)</span><br><span class="line">        - 正整数 <span class="number">0</span> ～ <span class="number">2147483647</span></span><br><span class="line"></span><br><span class="line">    BigIntegerField(IntegerField):</span><br><span class="line">        - 长整型(有符号的) <span class="number">-9223372036854775808</span> ～ <span class="number">9223372036854775807</span></span><br><span class="line"></span><br><span class="line">    自定义无符号整数字段</span><br><span class="line"></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">UnsignedIntegerField</span><span class="params">(models.IntegerField)</span>:</span></span><br><span class="line">            <span class="function"><span class="keyword">def</span> <span class="title">db_type</span><span class="params">(self, connection)</span>:</span></span><br><span class="line">                <span class="keyword">return</span> <span class="string">'integer UNSIGNED'</span></span><br><span class="line"></span><br><span class="line">        PS: 返回值为字段在数据库中的属性，Django字段默认的值为：</span><br><span class="line">            <span class="string">'AutoField'</span>: <span class="string">'integer AUTO_INCREMENT'</span>,</span><br><span class="line">            <span class="string">'BigAutoField'</span>: <span class="string">'bigint AUTO_INCREMENT'</span>,</span><br><span class="line">            <span class="string">'BinaryField'</span>: <span class="string">'longblob'</span>,</span><br><span class="line">            <span class="string">'BooleanField'</span>: <span class="string">'bool'</span>,</span><br><span class="line">            <span class="string">'CharField'</span>: <span class="string">'varchar(%(max_length)s)'</span>,</span><br><span class="line">            <span class="string">'CommaSeparatedIntegerField'</span>: <span class="string">'varchar(%(max_length)s)'</span>,</span><br><span class="line">            <span class="string">'DateField'</span>: <span class="string">'date'</span>,</span><br><span class="line">            <span class="string">'DateTimeField'</span>: <span class="string">'datetime'</span>,</span><br><span class="line">            <span class="string">'DecimalField'</span>: <span class="string">'numeric(%(max_digits)s, %(decimal_places)s)'</span>,</span><br><span class="line">            <span class="string">'DurationField'</span>: <span class="string">'bigint'</span>,</span><br><span class="line">            <span class="string">'FileField'</span>: <span class="string">'varchar(%(max_length)s)'</span>,</span><br><span class="line">            <span class="string">'FilePathField'</span>: <span class="string">'varchar(%(max_length)s)'</span>,</span><br><span class="line">            <span class="string">'FloatField'</span>: <span class="string">'double precision'</span>,</span><br><span class="line">            <span class="string">'IntegerField'</span>: <span class="string">'integer'</span>,</span><br><span class="line">            <span class="string">'BigIntegerField'</span>: <span class="string">'bigint'</span>,</span><br><span class="line">            <span class="string">'IPAddressField'</span>: <span class="string">'char(15)'</span>,</span><br><span class="line">            <span class="string">'GenericIPAddressField'</span>: <span class="string">'char(39)'</span>,</span><br><span class="line">            <span class="string">'NullBooleanField'</span>: <span class="string">'bool'</span>,</span><br><span class="line">            <span class="string">'OneToOneField'</span>: <span class="string">'integer'</span>,</span><br><span class="line">            <span class="string">'PositiveIntegerField'</span>: <span class="string">'integer UNSIGNED'</span>,</span><br><span class="line">            <span class="string">'PositiveSmallIntegerField'</span>: <span class="string">'smallint UNSIGNED'</span>,</span><br><span class="line">            <span class="string">'SlugField'</span>: <span class="string">'varchar(%(max_length)s)'</span>,</span><br><span class="line">            <span class="string">'SmallIntegerField'</span>: <span class="string">'smallint'</span>,</span><br><span class="line">            <span class="string">'TextField'</span>: <span class="string">'longtext'</span>,</span><br><span class="line">            <span class="string">'TimeField'</span>: <span class="string">'time'</span>,</span><br><span class="line">            <span class="string">'UUIDField'</span>: <span class="string">'char(32)'</span>,</span><br><span class="line"></span><br><span class="line">    BooleanField(Field)</span><br><span class="line">        - 布尔值类型</span><br><span class="line"></span><br><span class="line">    NullBooleanField(Field):</span><br><span class="line">        - 可以为空的布尔值</span><br><span class="line"></span><br><span class="line">    CharField(Field)</span><br><span class="line">        - 字符类型</span><br><span class="line">        - 必须提供max_length参数， max_length表示字符长度</span><br><span class="line"></span><br><span class="line">    TextField(Field)</span><br><span class="line">        - 文本类型</span><br><span class="line"></span><br><span class="line">    EmailField(CharField)：</span><br><span class="line">        - 字符串类型，Django Admin以及ModelForm中提供验证机制</span><br><span class="line"></span><br><span class="line">    IPAddressField(Field)</span><br><span class="line">        - 字符串类型，Django Admin以及ModelForm中提供验证 IPV4 机制</span><br><span class="line"></span><br><span class="line">    GenericIPAddressField(Field)</span><br><span class="line">        - 字符串类型，Django Admin以及ModelForm中提供验证 Ipv4和Ipv6</span><br><span class="line">        - 参数：</span><br><span class="line">            protocol，用于指定Ipv4或Ipv6， <span class="string">'both'</span>,<span class="string">"ipv4"</span>,<span class="string">"ipv6"</span></span><br><span class="line">            unpack_ipv4， 如果指定为<span class="keyword">True</span>，则输入::ffff:<span class="number">192.0</span><span class="number">.2</span><span class="number">.1</span>时候，可解析为<span class="number">192.0</span><span class="number">.2</span><span class="number">.1</span>，开启刺功能，需要protocol=<span class="string">"both"</span></span><br><span class="line"></span><br><span class="line">    URLField(CharField)</span><br><span class="line">        - 字符串类型，Django Admin以及ModelForm中提供验证 URL</span><br><span class="line"></span><br><span class="line">    SlugField(CharField)</span><br><span class="line">        - 字符串类型，Django Admin以及ModelForm中提供验证支持 字母、数字、下划线、连接符（减号）</span><br><span class="line"></span><br><span class="line">    CommaSeparatedIntegerField(CharField)</span><br><span class="line">        - 字符串类型，格式必须为逗号分割的数字</span><br><span class="line"></span><br><span class="line">    UUIDField(Field)</span><br><span class="line">        - 字符串类型，Django Admin以及ModelForm中提供对UUID格式的验证</span><br><span class="line"></span><br><span class="line">    FilePathField(Field)</span><br><span class="line">        - 字符串，Django Admin以及ModelForm中提供读取文件夹下文件的功能</span><br><span class="line">        - 参数：</span><br><span class="line">                path,                      文件夹路径</span><br><span class="line">                match=<span class="keyword">None</span>,                正则匹配</span><br><span class="line">                recursive=<span class="keyword">False</span>,           递归下面的文件夹</span><br><span class="line">                allow_files=<span class="keyword">True</span>,          允许文件</span><br><span class="line">                allow_folders=<span class="keyword">False</span>,       允许文件夹</span><br><span class="line"></span><br><span class="line">    FileField(Field)</span><br><span class="line">        - 字符串，路径保存在数据库，文件上传到指定目录</span><br><span class="line">        - 参数：</span><br><span class="line">            upload_to = <span class="string">""</span>      上传文件的保存路径</span><br><span class="line">            storage = <span class="keyword">None</span>      存储组件，默认django.core.files.storage.FileSystemStorage</span><br><span class="line"></span><br><span class="line">    ImageField(FileField)</span><br><span class="line">        - 字符串，路径保存在数据库，文件上传到指定目录</span><br><span class="line">        - 参数：</span><br><span class="line">            upload_to = <span class="string">""</span>      上传文件的保存路径</span><br><span class="line">            storage = <span class="keyword">None</span>      存储组件，默认django.core.files.storage.FileSystemStorage</span><br><span class="line">            width_field=<span class="keyword">None</span>,   上传图片的高度保存的数据库字段名（字符串）</span><br><span class="line">            height_field=<span class="keyword">None</span>   上传图片的宽度保存的数据库字段名（字符串）</span><br><span class="line"></span><br><span class="line">    DateTimeField(DateField)</span><br><span class="line">        - 日期+时间格式 YYYY-MM-DD HH:MM[:ss[.uuuuuu]][TZ]</span><br><span class="line"></span><br><span class="line">    DateField(DateTimeCheckMixin, Field)</span><br><span class="line">        - 日期格式      YYYY-MM-DD</span><br><span class="line"></span><br><span class="line">    TimeField(DateTimeCheckMixin, Field)</span><br><span class="line">        - 时间格式      HH:MM[:ss[.uuuuuu]]</span><br><span class="line"></span><br><span class="line">    DurationField(Field)</span><br><span class="line">        - 长整数，时间间隔，数据库中按照bigint存储，ORM中获取的值为datetime.timedelta类型</span><br><span class="line"></span><br><span class="line">    FloatField(Field)</span><br><span class="line">        - 浮点型</span><br><span class="line"></span><br><span class="line">    DecimalField(Field)</span><br><span class="line">        - <span class="number">10</span>进制小数</span><br><span class="line">        - 参数：</span><br><span class="line">            max_digits，小数总长度</span><br><span class="line">            decimal_places，小数位长度</span><br><span class="line"></span><br><span class="line">    BinaryField(Field)</span><br><span class="line">        - 二进制类型</span><br><span class="line"></span><br><span class="line">字段</span><br></pre></td></tr></table></figure>
<p>③参数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">(<span class="number">1</span>)null</span><br><span class="line"> </span><br><span class="line">如果为 <span class="keyword">True</span>，Django 将用 NULL 来在数据库中存储空值。 默认值是 <span class="keyword">False</span>.</span><br><span class="line"> </span><br><span class="line">(<span class="number">1</span>)blank</span><br><span class="line"> </span><br><span class="line">如果为 <span class="keyword">True</span>，该字段允许不填。默认为 <span class="keyword">False</span>。</span><br><span class="line">要注意，这与 null 不同。null 纯粹是数据库范畴的，而 blank 是数据验证范畴的。</span><br><span class="line">如果一个字段的blank=<span class="keyword">True</span>，表单的验证将允许该字段是空值。如果字段的blank=<span class="keyword">False</span>，该字段就是必填的。</span><br><span class="line"> </span><br><span class="line">(<span class="number">2</span>)default</span><br><span class="line"> </span><br><span class="line">字段的默认值。可以是一个值或者可调用对象。如果可调用 ，每有新对象被创建它都会被调用。</span><br><span class="line"> </span><br><span class="line">(<span class="number">3</span>)primary_key</span><br><span class="line"> </span><br><span class="line">如果为<span class="keyword">True</span>，那么这个字段就是模型的主键。如果你没有指定任何一个字段的primary_key=<span class="keyword">True</span>，</span><br><span class="line">Django 就会自动添加一个IntegerField字段做为主键，所以除非你想覆盖默认的主键行为，</span><br><span class="line">否则没必要设置任何一个字段的primary_key=<span class="keyword">True</span>。</span><br><span class="line"> </span><br><span class="line">(<span class="number">4</span>)unique</span><br><span class="line"> </span><br><span class="line">如果该值设置为 <span class="keyword">True</span>, 这个数据字段的值在整张表中必须是唯一的</span><br><span class="line"> </span><br><span class="line">(<span class="number">5</span>)choices</span><br><span class="line">由二元组组成的一个可迭代对象（例如，列表或元组），用来给字段提供选择项。 如果设置了choices ，默认的表单将是一个选择框而不是标准的文本框，&lt;br&gt;而且这个选择框的选项就是choices 中的选项。</span><br><span class="line"></span><br><span class="line">参数</span><br></pre></td></tr></table></figure>
<p>④元信息</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">        nid = models.AutoField(primary_key=<span class="keyword">True</span>)</span><br><span class="line">        username = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">            <span class="comment"># 数据库中生成的表名称 默认 app名称 + 下划线 + 类名</span></span><br><span class="line">            db_table = <span class="string">"table_name"</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 联合索引</span></span><br><span class="line">            index_together = [</span><br><span class="line">                (<span class="string">"pub_date"</span>, <span class="string">"deadline"</span>),</span><br><span class="line">            ]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 联合唯一索引</span></span><br><span class="line">            unique_together = ((<span class="string">"driver"</span>, <span class="string">"restaurant"</span>),)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># admin中显示的表名称</span></span><br><span class="line">            verbose_name</span><br><span class="line"></span><br><span class="line">            <span class="comment"># verbose_name加s</span></span><br><span class="line">            verbose_name_plural</span><br></pre></td></tr></table></figure>
<p>⑤增加删除字段</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">删除，直接注释掉字段，执行数据库迁移命令即可</span><br><span class="line"></span><br><span class="line">新增字段，在类里直接新增字段，直接执行数据库迁移命令会提示输入默认值，此时需要设置</span><br><span class="line">QuerySet_obj = models.CharField(max_length=<span class="number">12</span>,default=<span class="string">'xxx'</span>,null=<span class="keyword">True</span>)</span><br></pre></td></tr></table></figure>
<p>⑥添加表记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># create方法的返回值book_obj就是插入book表中的python葵花宝典这本书籍纪录对象</span></span><br><span class="line">QuerySet_obj=Book.objects.create(字段=value,pub_date=<span class="string">"2012-12-12"</span>)</span><br><span class="line"><span class="comment"># 注意：时间格式必须是字符串</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">obj=Book(字段=value,pub_date=<span class="string">"2012-12-12"</span>)</span><br><span class="line">obj.save()</span><br><span class="line"><span class="comment"># 注意：该方法必须调用保存</span></span><br></pre></td></tr></table></figure>
<p>⑦查询表记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="number">1</span>&gt; all():                  查询所有结果</span><br><span class="line">  </span><br><span class="line">&lt;<span class="number">2</span>&gt; filter(**kwargs):       它包含了与所给筛选条件相匹配的对象</span><br><span class="line">  </span><br><span class="line">&lt;<span class="number">3</span>&gt; get(**kwargs):          返回与所给筛选条件相匹配的对象，返回结果有且只有一个，如果符合筛选条件的对象超过一个或者没有都会抛出错误。</span><br><span class="line">  </span><br><span class="line">&lt;<span class="number">4</span>&gt; exclude(**kwargs):      它包含了与所给筛选条件不匹配的对象</span><br><span class="line"> </span><br><span class="line">&lt;<span class="number">5</span>&gt; order_by(*field):       对查询结果排序(<span class="string">'-id'</span>)</span><br><span class="line">  </span><br><span class="line">&lt;<span class="number">6</span>&gt; reverse():              对查询结果反向排序</span><br><span class="line">  </span><br><span class="line">&lt;<span class="number">8</span>&gt; count():                返回数据库中匹配查询(QuerySet)的对象数量。</span><br><span class="line">  </span><br><span class="line">&lt;<span class="number">9</span>&gt; first():                返回第一条记录</span><br><span class="line">  </span><br><span class="line">&lt;<span class="number">10</span>&gt; last():                返回最后一条记录</span><br><span class="line">  </span><br><span class="line">&lt;<span class="number">11</span>&gt; exists():              如果QuerySet包含数据，就返回<span class="keyword">True</span>，否则返回<span class="keyword">False</span></span><br><span class="line"> </span><br><span class="line">&lt;<span class="number">12</span>&gt; values(*field):        返回一个ValueQuerySet——一个特殊的QuerySet，运行后得到的并不是一系列</span><br><span class="line">                            model的实例化对象，而是一个可迭代的字典序列</span><br><span class="line">&lt;<span class="number">13</span>&gt; values_list(*field):   它与values()非常相似，它返回的是一个元组序列，values返回的是一个字典序列</span><br><span class="line"> </span><br><span class="line">&lt;<span class="number">14</span>&gt; distinct():            从返回结果中剔除重复纪录</span><br></pre></td></tr></table></figure>
<p>⑧基于双下划线的模糊查询</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Book.objects.filter(price__in=[<span class="number">100</span>,<span class="number">200</span>,<span class="number">300</span>])</span><br><span class="line">Book.objects.filter(price__gt=<span class="number">100</span>)</span><br><span class="line">Book.objects.filter(price__lt=<span class="number">100</span>)</span><br><span class="line">Book.objects.filter(price__gte=<span class="number">100</span>)</span><br><span class="line">Book.objects.filter(price__lte=<span class="number">100</span>)</span><br><span class="line">Book.objects.filter(price__range=[<span class="number">100</span>,<span class="number">200</span>])</span><br><span class="line">Book.objects.filter(title__contains=<span class="string">"python"</span>)</span><br><span class="line">Book.objects.filter(title__icontains=<span class="string">"python"</span>)</span><br><span class="line">Book.objects.filter(title__startswith=<span class="string">"py"</span>)</span><br><span class="line">Book.objects.filter(pub_date__year=<span class="number">2012</span>)</span><br></pre></td></tr></table></figure>
<p>⑨删除表记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">model_obj.delete()</span><br><span class="line">它运行时立即删除对象而不返回任何值。</span><br><span class="line">---------------------------------------------------------</span><br><span class="line">可以一次性删除多个对象。每个 QuerySet 都有一个 delete() 方法，它一次性删除 QuerySet 中所有的对象。</span><br><span class="line">Entry.objects.filter(pub_date__year=<span class="number">2005</span>).delete()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意：</span></span><br><span class="line">	Django <span class="number">2.</span>+版本删除关联字段时，models.py 关联表中的关联字段必须设置 ON_DELETE=models.CASECADE</span><br><span class="line">    若不想级联删除，可设置</span><br><span class="line">    models.ForeignKey(to=<span class="string">'Publisher'</span>, on_delete=models.SET_NULL, blank=<span class="keyword">True</span>, null=<span class="keyword">True</span>)</span><br><span class="line">    </span><br><span class="line">    delete() 方法是 QuerySet 上的方法，但并不适用于 Manager 本身。</span><br></pre></td></tr></table></figure>
<p>⑩修改表记录</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Book.objects.filter(title__startswith=<span class="string">"py"</span>).update(price=<span class="number">120</span>）</span><br><span class="line">                                                   </span><br><span class="line">update()方法对于任何结果集（QuerySet）均有效，这意味着你可以同时更新多条记录update()方法会返回一个整型数值，表示受影响的记录条数。</span><br></pre></td></tr></table></figure>
<ul>
<li>多表操作</li>
</ul>
<h4 id="添加表记录"><a href="#添加表记录" class="headerlink" title="添加表记录"></a>添加表记录</h4><p>①一对多</p>
<p>②多对多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">book_obj.authors.add(yuan,egon) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">book_obj.authors.remove()      <span class="comment"># 将某个特定的对象从被关联对象集合中去除。    ======   book_obj.authors.remove(*[])</span></span><br><span class="line">book_obj.authors.clear()       <span class="comment">#清空被关联对象集合</span></span><br><span class="line">book_obj.authors.set()         <span class="comment">#先清空再设置</span></span><br></pre></td></tr></table></figure>
<h4 id="跨表查询"><a href="#跨表查询" class="headerlink" title="跨表查询"></a>跨表查询</h4><p>①一对一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">正向查询(按字段：authorDetail)</span><br><span class="line">obj=Author.objects.filter(name=<span class="string">"xxx"</span>).first()</span><br><span class="line">print(obj.authorDetail.telephone)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">反向查询(按表名：author)</span><br><span class="line"><span class="comment"># 查询所有住址在北京的作者的姓名</span></span><br><span class="line">authorDetail_list=AuthorDetail.objects.filter(addr=<span class="string">"beijing"</span>)</span><br><span class="line"><span class="keyword">for</span> obj <span class="keyword">in</span> authorDetail_list:</span><br><span class="line">     print(obj.author.name)</span><br></pre></td></tr></table></figure>
<p>②一对多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">正向查询（按字段：publish）</span><br><span class="line"><span class="comment"># 查询主键为1的书籍的出版社所在的城市</span></span><br><span class="line">book_obj=Book.objects.filter(pk=<span class="number">1</span>).first()</span><br><span class="line"><span class="comment"># book_obj.publish 是主键为1的书籍对象关联的出版社对象</span></span><br><span class="line">print(book_obj.publish.city)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">反向查询（按表名：book_set）</span><br><span class="line">publish=Publish.objects.get(name=<span class="string">"苹果出版社"</span>)</span><br><span class="line"><span class="comment">#publish.book_set.all() : 与苹果出版社关联的所有书籍对象集合</span></span><br><span class="line">book_list=publish.book_set.all()    </span><br><span class="line"><span class="keyword">for</span> book_obj <span class="keyword">in</span> book_list:</span><br><span class="line">       print(book_obj.title)</span><br></pre></td></tr></table></figure>
<p>③多对多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">正向查询(按字段：authors)</span><br><span class="line"><span class="comment"># 所有作者的名字以及手机号</span></span><br><span class="line">book_obj=Book.objects.filter(title=<span class="string">"眉"</span>).first()</span><br><span class="line">authors=book_obj.authors.all()</span><br><span class="line"><span class="keyword">for</span> author_obj <span class="keyword">in</span> authors:</span><br><span class="line">     print(author_obj.name,author_obj.authorDetail.telephone)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">反向查询(按表名：book_set)</span><br><span class="line"><span class="comment"># 查询xxx出过的所有书籍的名字</span></span><br><span class="line"> </span><br><span class="line">author_obj=Author.objects.get(name=<span class="string">"xxx"</span>)</span><br><span class="line">book_list=author_obj.book_set.all()       </span><br><span class="line"><span class="keyword">for</span> book_obj <span class="keyword">in</span> book_list:</span><br><span class="line">    print(book_obj.title)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意：</span></span><br><span class="line">可通过在 ForeignKey() 和ManyToManyField的定义中设置 related_name 的值来覆写 FOO_set 的名称。</span><br><span class="line">publish = ForeignKey(Book, related_name=<span class="string">'bookList'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查询 人民出版社出版过的所有书籍</span></span><br><span class="line">publish=Publish.objects.get(name=<span class="string">"人民出版社"</span>)</span><br><span class="line">book_list=publish.bookList.all()  <span class="comment"># 与人民出版社关联的所有书籍对象集合</span></span><br></pre></td></tr></table></figure>
<h4 id="双下滑下跨表查询"><a href="#双下滑下跨表查询" class="headerlink" title="双下滑下跨表查询"></a>双下滑下跨表查询</h4><p>①一对多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向查询 按字段:publish</span></span><br><span class="line">queryResult=Book.objects.filter(publish__name=<span class="string">"苹果出版社"</span>).values_list(<span class="string">"title"</span>,<span class="string">"price"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向查询 按表名:book</span></span><br><span class="line">queryResult=Publish.objects.filter(name=<span class="string">"苹果出版			社"</span>).values_list(<span class="string">"book__title"</span>,<span class="string">"book__price"</span>)</span><br></pre></td></tr></table></figure>
<p>②多对多</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向查询 按字段:authors:</span></span><br><span class="line">queryResult=Book.objects.filter(authors__name=<span class="string">"xxx"</span>).values_list(<span class="string">"title"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向查询 按表名:book</span></span><br><span class="line">queryResult=Author.objects.filter(name=<span class="string">"xxx"</span>).values_list(<span class="string">"book__title"</span>,<span class="string">"book__price"</span>)</span><br></pre></td></tr></table></figure>
<p>③一对一</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 正向查询</span></span><br><span class="line">ret=Author.objects.filter(name=<span class="string">"xxx"</span>).values(<span class="string">"authordetail__telephone"</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 反向查询</span></span><br><span class="line">ret=AuthorDetail.objects.filter(author__name=<span class="string">"alex"</span>).values(<span class="string">"telephone"</span>)</span><br></pre></td></tr></table></figure>
<h4 id="聚合查询和分组查询"><a href="#聚合查询和分组查询" class="headerlink" title="聚合查询和分组查询"></a>聚合查询和分组查询</h4><ul>
<li>aggregate(*args,**kwargs)</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 计算所有图书的平均价格</span></span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Avg,Max, Min</span><br><span class="line">Book.objects.all().aggregate(Avg(<span class="string">'price'</span>))</span><br><span class="line"></span><br><span class="line">Book.objects.aggregate(Avg(<span class="string">'price'</span>), Max(<span class="string">'price'</span>), Min(<span class="string">'price'</span>))</span><br></pre></td></tr></table></figure>
<ul>
<li>annotate()</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">annotate()为调用的QuerySet中每一个对象都生成一个独立的统计值（统计方法用聚合函数）。</span><br><span class="line"></span><br><span class="line">总结 ：跨表分组查询本质就是将关联表join成一张表，再按单表的思路进行分组查询。</span><br></pre></td></tr></table></figure>
<h4 id="F查询和Q查询"><a href="#F查询和Q查询" class="headerlink" title="F查询和Q查询"></a>F查询和Q查询</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> F</span><br><span class="line">Django 提供 F() 来做这样的比较。F() 的实例可以在查询中引用字段，来比较同一个 model 实例中两个不同字段的值。</span><br><span class="line"><span class="comment"># 查询评论数大于收藏数的书籍</span></span><br><span class="line">Book.objects.filter(commnetNum__lt=F(<span class="string">'keepNum'</span>))</span><br><span class="line"></span><br><span class="line">Django 支持 F() 对象之间以及 F() 对象和常数之间的加减乘除和取模的操作。</span><br><span class="line"><span class="comment"># 查询评论数大于收藏数2倍的书籍</span></span><br><span class="line">Book.objects.filter(commnetNum__lt=F(<span class="string">'keepNum'</span>)*<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">修改操作也可以使用F函数,比如将每一本书的价格提高<span class="number">30</span>元</span><br><span class="line">Book.objects.all().update(price=F(<span class="string">"price"</span>)+<span class="number">30</span>)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line">Q 对象可以使用 &amp; 和 | 操作符组合起来。当一个操作符在两个 Q 对象上使用时，它产生一个新的 Q 对象。</span><br><span class="line">bookList=Book.objects.filter(Q(authors__name=<span class="string">"a"</span>)|Q(authors__name=<span class="string">"b"</span>))</span><br></pre></td></tr></table></figure>
<h1 id="六、组件"><a href="#六、组件" class="headerlink" title="六、组件"></a>六、组件</h1><h2 id="1-Ajax"><a href="#1-Ajax" class="headerlink" title="1.Ajax"></a>1.Ajax</h2><ul>
<li><p>定义</p>
<p>AJAX（Asynchronous Javascript And XML）翻译成中文就是“异步Javascript和XML”。即使用Javascript语言与服务器进行异步交互，传输的数据为XML（当然，传输的数据不只是XML,现在更多使用json数据）。</p>
</li>
</ul>
<p>​      特点：①异步交互—客户端发出请求后,无需等待服务器响应结束,就可以发出第二个请求 ; ②浏览器页面<strong>局部刷新</strong> </p>
<p>​      优点：①使用Javascript技术向服务器发送异步请求②无须刷新整个页面 </p>
<ul>
<li>XMLHttpResponse 方式</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">XMLHttpResponse:</span><br><span class="line">    ① 生成对象</span><br><span class="line">    ② 处理数据</span><br><span class="line">    ③ 发送数据</span><br><span class="line">    ④ 监听事件</span><br></pre></td></tr></table></figure>
<ul>
<li>Django 方式（常用）</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ajax(&#123;            <span class="comment">// 是JQuery最底层的实现原理</span></span><br><span class="line">    url:<span class="string">""</span>,</span><br><span class="line">    type:<span class="string">""</span>,</span><br><span class="line">    data:&#123;&#125;,</span><br><span class="line">    <span class="comment">// dataType:"json",   //client 向 server指定接收的数据类型</span></span><br><span class="line">    <span class="comment">// contentType:"",  //告诉jQuery不要去设置Content-Type请求头</span></span><br><span class="line">    <span class="comment">// processData:boolean，// 告诉浏览器是否处理数据</span></span><br><span class="line">    <span class="comment">// data.parse()       // 将数据解析成指定格式</span></span><br><span class="line">    <span class="comment">// data.Jsonify()    // 将接接收的数据变成json类型</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>应用场景:登录验证 </li>
</ul>
<ul>
<li>文件上传</li>
</ul>
<p>①ContentType请求头</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">application/x-www-form-urlencoded</span><br><span class="line">最常见的 POST 提交数据的方式了。浏览器的原生 &lt;form&gt; 表单，如果不设置 enctype 属性，那么最终就会以 application/x-www-form-urlencoded 方式提交数据</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">multipart/form-data</span><br><span class="line">常见的 POST 数据提交的方式。我们使用表单上传文件时，必须让 &lt;form&gt; 表单的 enctype 等于 multipart/form-data</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">application/json</span><br><span class="line">用来告诉服务端消息主体是序列化后的 JSON 字符串。由于 JSON 规范的流行，除了低版本 IE 之外的各大浏览器都原生支持 JSON.stringify，服务端语言也都有处理 JSON 的函数，使用 JSON 不会遇上什么麻烦。</span><br></pre></td></tr></table></figure>
<ul>
<li>基于Form表单上传文件</li>
</ul>
<p>html 文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"/file_put/"</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">enctype</span>=<span class="string">"multipart/form-data"</span>&gt;</span></span><br><span class="line">    用户名：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span></span><br><span class="line">    头像：<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"file"</span> <span class="attr">name</span>=<span class="string">"avatar"</span> <span class="attr">id</span>=<span class="string">"avatar1"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">value</span>=<span class="string">"提交"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>py文件视图函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">file_put</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">'GET'</span>:</span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">'file_put.html'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(request.body)  <span class="comment"># 原始的请求体数据 </span></span><br><span class="line">        print(request.GET)  <span class="comment"># GET请求数据 </span></span><br><span class="line">        print(request.POST)  <span class="comment"># POST请求数据 </span></span><br><span class="line">        print(request.FILES)  <span class="comment"># 上传的文件数据</span></span><br><span class="line">        print(request.body.decode(<span class="string">'utf-8'</span>))</span><br><span class="line">        </span><br><span class="line">        file_obj=request.FILES.get(<span class="string">'avatar'</span>)</span><br><span class="line">        print(type(file_obj))</span><br><span class="line">        <span class="keyword">with</span> open(file_obj.name,<span class="string">'wb'</span>) <span class="keyword">as</span> f:</span><br><span class="line">            <span class="keyword">for</span> line <span class="keyword">in</span> file_obj:</span><br><span class="line">                f.write(line)</span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'ok'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>基于Ajax上传</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$(<span class="string">"#ajax_button"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> formdata=<span class="keyword">new</span> FormData()</span><br><span class="line">    formdata.append(<span class="string">'name'</span>,$(<span class="string">"#id_name2"</span>).val())</span><br><span class="line">    formdata.append(<span class="string">'avatar'</span>,$(<span class="string">"#avatar2"</span>)[<span class="number">0</span>].files[<span class="number">0</span>])</span><br><span class="line">    $.ajax(&#123;</span><br><span class="line">        url:<span class="string">''</span>,</span><br><span class="line">        type:<span class="string">'post'</span>,</span><br><span class="line">        processData:<span class="literal">false</span>, <span class="comment">//告诉jQuery不要去处理发送的数据</span></span><br><span class="line">        contentType:<span class="literal">false</span>,<span class="comment">// 告诉jQuery不要去设置Content-Type请求头</span></span><br><span class="line">        data:formdata,</span><br><span class="line">        success:<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(data)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>Ajax提交json格式的数据</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">    $(<span class="string">"#ajax_test"</span>).click(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> dic=&#123;<span class="string">'name'</span>:<span class="string">'lqz'</span>,<span class="string">'age'</span>:<span class="number">18</span>&#125;</span><br><span class="line">        $.ajax(&#123;</span><br><span class="line">            url:<span class="string">''</span>,</span><br><span class="line">            type:<span class="string">'post'</span>,</span><br><span class="line">            contentType:<span class="string">'application/json'</span>,  <span class="comment">//一定要指定格式 contentType: 'application/json;charset=utf-8',</span></span><br><span class="line">            data:<span class="built_in">JSON</span>.stringify(dic),    <span class="comment">//转换成json字符串格式</span></span><br><span class="line">            success:<span class="function"><span class="keyword">function</span> (<span class="params">data</span>) </span>&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(data)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">提交到服务器的数据都在 request.body 里，取出来自行处理</span><br></pre></td></tr></table></figure>
<h2 id="2-分页器"><a href="#2-分页器" class="headerlink" title="2.分页器"></a>2.分页器</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator,EmptyPage, PageNotAnInteger</span><br><span class="line"></span><br><span class="line">Paginator对象：    paginator = Paginator(user_list, <span class="number">10</span>)</span><br><span class="line"><span class="comment"># paginator.per_page:  每页显示条目数量</span></span><br><span class="line"><span class="comment"># paginator.count:     数据总个数</span></span><br><span class="line"><span class="comment"># paginator.num_pages: 总页数</span></span><br><span class="line"><span class="comment"># paginator.page_range:总页数的索引范围，如: (1,10),(1,200)</span></span><br><span class="line"><span class="comment"># paginator.page:      page对象    </span></span><br><span class="line">page对象：page=paginator.page(<span class="number">1</span>)  <span class="comment">#第1页的page对象</span></span><br><span class="line"><span class="comment"># page1.has_next              是否有下一页</span></span><br><span class="line"><span class="comment"># page1.next_page_number      下一页页码</span></span><br><span class="line"><span class="comment"># page1.has_previous          是否有上一页</span></span><br><span class="line"><span class="comment"># page1.previous_page_number  上一页页码</span></span><br><span class="line"><span class="comment"># page1.object_list           分页之后的数据列表</span></span><br><span class="line"><span class="comment"># page1.number                当前页</span></span><br><span class="line"><span class="comment"># page1.paginator             paginator对象</span></span><br></pre></td></tr></table></figure>
<ul>
<li>批量导入数据</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Booklist=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    Booklist.append(Book(title=<span class="string">"book"</span>+str(i),price=<span class="number">30</span>+i*i))</span><br><span class="line">Book.objects.bulk_create(Booklist)</span><br></pre></td></tr></table></figure>
<ul>
<li>View视图函数</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,HttpResponse</span><br><span class="line"><span class="keyword">from</span> app01.models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> django.core.paginator <span class="keyword">import</span> Paginator, EmptyPage, PageNotAnInteger</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    book_list=Book.objects.all()</span><br><span class="line">    paginator = Paginator(book_list, <span class="number">10</span>)  </span><br><span class="line">    page = request.GET.get(<span class="string">'page'</span>,<span class="number">1</span>)   <span class="comment"># 从客户端传过来的所显示的当前页面</span></span><br><span class="line">    currentPage=int(page)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(page)</span><br><span class="line">        book_list = paginator.page(page)</span><br><span class="line">    <span class="keyword">except</span> PageNotAnInteger:</span><br><span class="line">        book_list = paginator.page(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> EmptyPage:</span><br><span class="line">        book_list = paginator.page(paginator.num_pages)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">"index.html"</span>,&#123;<span class="string">"book_list"</span>:book_list,<span class="string">"paginator"</span>:paginator,<span class="string">"currentPage"</span>:currentPage&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>模板层 index.html</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"</span> </span></span><br><span class="line"><span class="tag">    <span class="attr">integrity</span>=<span class="string">"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>分页器<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        &#123;% for book in book_list %&#125;</span><br><span class="line">             <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; book.title &#125;&#125; -----&#123;&#123; book.price &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">     <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination"</span> <span class="attr">id</span>=<span class="string">"pager"</span>&gt;</span></span><br><span class="line">                 &#123;% if book_list.has_previous %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"previous"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/index/?page=&#123;&#123; book_list.previous_page_number &#125;&#125;"</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                 &#123;% else %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"previous disabled"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                 &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                 &#123;% for num in paginator.page_range %&#125;</span><br><span class="line">                     &#123;% if num == currentPage %&#125;</span><br><span class="line">                       <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"item active"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/index/?page=&#123;&#123; num &#125;&#125;"</span>&gt;</span>&#123;&#123; num &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                     &#123;% else %&#125;</span><br><span class="line">                       <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"item"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/index/?page=&#123;&#123; num &#125;&#125;"</span>&gt;</span>&#123;&#123; num &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                     &#123;% endif %&#125;</span><br><span class="line">                 &#123;% endfor %&#125;</span><br><span class="line"></span><br><span class="line">                 &#123;% if book_list.has_next %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"next"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/index/?page=&#123;&#123; book_list.next_page_number &#125;&#125;"</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                 &#123;% else %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"next disabled"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">                 &#123;% endif %&#125;</span><br><span class="line">            <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>核心逻辑</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">显示左5，右5，总共11个页，</span><br><span class="line">1 如果总页码大于11</span><br><span class="line">    1.1 if 当前页码减5小于1，要生成1到12的列表（顾头不顾尾，共11个页码）</span><br><span class="line">        page_range=range(1,12)</span><br><span class="line">    1.2 elif 当前页码+5大于总页码，生成当前页码减10，到当前页码加1的列表（顾头不顾尾，共11个页码）</span><br><span class="line">        page_range=range(paginator.num_pages-10,paginator.num_pages+1)</span><br><span class="line">    1.3 else 生成当前页码-5，到当前页码+6的列表</span><br><span class="line">         page_range=range(current_page_num-5,current_page_num+6)</span><br><span class="line">2 其它情况，生成的列表就是pageinator的page_range</span><br><span class="line">    page_range=paginator.page_range</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    book_list=Book.objects.all()</span><br><span class="line">    paginator = Paginator(book_list, <span class="number">15</span>)</span><br><span class="line">    page = request.GET.get(<span class="string">'page'</span>,<span class="number">1</span>)</span><br><span class="line">    currentPage=int(page)</span><br><span class="line">    <span class="comment">#  如果页数十分多时，换另外一种显示方式</span></span><br><span class="line">    <span class="keyword">if</span> paginator.num_pages&gt;<span class="number">11</span>:</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> currentPage<span class="number">-5</span>&lt;<span class="number">1</span>:</span><br><span class="line">            pageRange=range(<span class="number">1</span>,<span class="number">11</span>)</span><br><span class="line">        <span class="keyword">elif</span> currentPage+<span class="number">5</span>&gt;paginator.num_pages:</span><br><span class="line">            pageRange=range(currentPage<span class="number">-5</span>,paginator.num_pages+<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            pageRange=range(currentPage<span class="number">-5</span>,currentPage+<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        pageRange=paginator.page_range</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        print(page)</span><br><span class="line">        book_list = paginator.page(page)</span><br><span class="line">    <span class="keyword">except</span> PageNotAnInteger:</span><br><span class="line">        book_list = paginator.page(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">except</span> EmptyPage:</span><br><span class="line">        book_list = paginator.page(paginator.num_pages)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">"index.html"</span>,locals())</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/static/bootstrap-3.3.7-dist/css/bootstrap.min.css"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">    &#123;% for foo in page %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span>&gt;</span>&#123;&#123; foo.name &#125;&#125;<span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line"><span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">nav</span> <span class="attr">aria-label</span>=<span class="string">"Page navigation"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">class</span>=<span class="string">"pagination"</span>&gt;</span></span><br><span class="line">        &#123;% if page.has_previous %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/page_test/?page=&#123;&#123; page.previous_page_number &#125;&#125;"</span> <span class="attr">aria-label</span>=<span class="string">"Previous"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"disabled"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">aria-label</span>=<span class="string">"Previous"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>上一页<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">        &#123;% for foo in page_range %&#125;</span><br><span class="line">            &#123;% if current_page == foo %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"active"</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/page_test/?page=&#123;&#123; foo &#125;&#125;"</span>&gt;</span>&#123;&#123; foo &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% else %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">li</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/page_test/?page=&#123;&#123; foo &#125;&#125;"</span>&gt;</span>&#123;&#123; foo &#125;&#125;<span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">            &#123;% endif %&#125;</span><br><span class="line"></span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">        </span><br><span class="line">        &#123;% if page.has_next %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"/page_test/?page=&#123;&#123; page.next_page_number &#125;&#125;"</span> <span class="attr">aria-label</span>=<span class="string">"Next"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% else %&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">li</span> <span class="attr">class</span>=<span class="string">"disabled"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">"#"</span> <span class="attr">aria-label</span>=<span class="string">"Next"</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">span</span> <span class="attr">aria-hidden</span>=<span class="string">"true"</span>&gt;</span>下一页<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">        &#123;% endif %&#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">nav</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="3-forms组件"><a href="#3-forms组件" class="headerlink" title="3.forms组件"></a>3.forms组件</h2><ul>
<li>校验字段（如用户注册）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">models.py</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    pwd=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    email=models.EmailField()</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">模板文件</span><br><span class="line"></span><br><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"user"</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">id</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"pwd"</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"pwd"</span> <span class="attr">id</span>=<span class="string">"pwd"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"r_pwd"</span>&gt;</span>确认密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"password"</span> <span class="attr">name</span>=<span class="string">"r_pwd"</span> <span class="attr">id</span>=<span class="string">"r_pwd"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">"email"</span>&gt;</span>邮箱<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">p</span>&gt;</span><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"email"</span> <span class="attr">id</span>=<span class="string">"email"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">视图函数</span><br><span class="line"></span><br><span class="line"><span class="comment"># forms组件</span></span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> widgets</span><br><span class="line"></span><br><span class="line">wid_01=widgets.TextInput(attrs=&#123;<span class="string">"class"</span>:<span class="string">"form-control"</span>&#125;)</span><br><span class="line">wid_02=widgets.PasswordInput(attrs=&#123;<span class="string">"class"</span>:<span class="string">"form-control"</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    name=forms.CharField(max_length=<span class="number">32</span>,</span><br><span class="line">                         widget=wid_01</span><br><span class="line">                         )</span><br><span class="line">    pwd=forms.CharField(max_length=<span class="number">32</span>,widget=wid_02)</span><br><span class="line">    r_pwd=forms.CharField(max_length=<span class="number">32</span>,widget=wid_02)</span><br><span class="line">    email=forms.EmailField(widget=wid_01)</span><br><span class="line">    tel=forms.CharField(max_length=<span class="number">32</span>,widget=wid_01)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="comment"># 此时 request.POST 字典中的数据是未验证过的证据</span></span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">"POST"</span>:</span><br><span class="line">        form=UserForm(request.POST)</span><br><span class="line">        <span class="comment"># 验证符合之后的字典形式数据</span></span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            print(form.cleaned_data)       <span class="comment"># 所有干净的字段以及对应的值</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(form.cleaned_data)       </span><br><span class="line">            print(form.errors.get(<span class="string">"__all__"</span>))</span><br><span class="line">            print(form.errors)             <span class="comment"># ErrorDict : &#123;"校验错误的字段":["错误信息",]&#125;</span></span><br><span class="line">            print(form.errors.get(<span class="string">"name"</span>)) <span class="comment"># ErrorList ["错误信息",]</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">"OK"</span>)</span><br><span class="line">    form=UserForm()</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">"register.html"</span>,locals())</span><br></pre></td></tr></table></figure>
<ul>
<li>渲染标签</li>
</ul>
<p>①方式一（拓展性高）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>注册<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"</span> <span class="attr">integrity</span>=<span class="string">"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>注册页面<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 col-lg-offset-3"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">                    &#123;% csrf_token %&#125;</span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>用户名<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        &#123;&#123; form.name &#125;&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        &#123;&#123; form.pwd &#125;&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>确认密码<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        &#123;&#123; form.r_pwd &#125;&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span> 邮箱<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">                        &#123;&#123; form.email &#125;&#125;</span><br><span class="line">                    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-default pull-right"</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>②方式二（推荐）</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">	&#123;% csrf_token %&#125;</span><br><span class="line">	&#123;% for field in form %&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">			&#123;&#123; field &#125;&#125;</span><br><span class="line">	<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">	&#123;% endfor %&#125;</span><br><span class="line">	<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-default pull-right"</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>③方式三</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;  </span><br><span class="line">    &#123;&#123; form.as_p &#125;  <span class="comment">&lt;!-- 直接全部当成p标签渲染 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-default pull-right"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>校验不通过错误信息渲染</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Views.py</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">"POST"</span>:</span><br><span class="line">        form=UserForm(request.POST)</span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            print(form.cleaned_data)       <span class="comment"># 所有干净的字段以及对应的值</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(form.cleaned_data)       <span class="comment">#</span></span><br><span class="line">            print(form.errors)             <span class="comment"># ErrorDict : &#123;"校验错误的字段":["错误信息",]&#125;</span></span><br><span class="line">            print(form.errors.get(<span class="string">"name"</span>)) <span class="comment"># ErrorList ["错误信息",]</span></span><br><span class="line">        <span class="keyword">return</span> render(request,<span class="string">"register.html"</span>,locals())</span><br><span class="line">    form=UserForm()</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">"register.html"</span>,locals())</span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">index.html</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>&gt;</span></span><br><span class="line">    &#123;% csrf_token %&#125;</span><br><span class="line">    &#123;% for field in form %&#125;</span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span></span><br><span class="line">            &#123;&#123; field &#125;&#125; </span><br><span class="line">            <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right"</span> <span class="attr">style</span>=<span class="string">"color: red"</span>&gt;</span>&#123;&#123; field.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    &#123;% endfor %&#125;</span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span> <span class="attr">class</span>=<span class="string">"btn btn-default"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>组件参数设置</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Ret</span><span class="params">(Form)</span>:</span></span><br><span class="line">    <span class="comment"># 这里有label之后,html中可以不用写label标签,可以添加错误信息,也可以控制组件的属性</span></span><br><span class="line">    name = forms.CharField(max_length=<span class="number">10</span>, min_length=<span class="number">2</span>, label=<span class="string">'用户名'</span>,</span><br><span class="line">                           error_messages=&#123;<span class="string">'required'</span>: <span class="string">'该字段不能为空'</span>, <span class="string">'invalid'</span>: <span class="string">'格式错误'</span>, 											<span class="string">'max_length'</span>: <span class="string">'太长'</span>,<span class="string">'min_length'</span>: <span class="string">'太短'</span>&#125;,</span><br><span class="line">                           widget=widgets.TextInput(attrs=&#123;<span class="string">'class'</span>:<span class="string">'form-control'</span>&#125;))</span><br><span class="line">    pwd = forms.CharField(max_length=<span class="number">10</span>, min_length=<span class="number">2</span>, widget=widgets.PasswordInput(attrs=																	&#123;<span class="string">'class'</span>:<span class="string">'form-control'</span>&#125;))</span><br><span class="line">    email = forms.EmailField(label=<span class="string">'邮箱'</span>, error_messages=&#123;<span class="string">'required'</span>: <span class="string">'该字段不能为空'</span>, <span class="string">'invalid'</span>: 																				<span class="string">'格式错误'</span>&#125;)</span><br></pre></td></tr></table></figure>
<ul>
<li>局部钩子（校验字段）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> NON_FIELD_ERRORS, ValidationError</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean_name</span><span class="params">(self)</span>:</span></span><br><span class="line">        val=self.cleaned_data.get(<span class="string">"name"</span>)</span><br><span class="line">        ret=UserInfo.objects.filter(name=val)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">            <span class="keyword">return</span> val</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">"该用户已注册!"</span>)</span><br><span class="line">            </span><br><span class="line">            </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean_tel</span><span class="params">(self)</span>:</span></span><br><span class="line">	val=self.cleaned_data.get(<span class="string">"tel"</span>)</span><br><span class="line">    </span><br><span class="line">	<span class="keyword">if</span> len(val)==<span class="number">11</span>:</span><br><span class="line">		<span class="keyword">return</span> val</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">raise</span>  ValidationError(<span class="string">"手机号格式错误"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>全局钩子（校验两次密码）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">	pwd=self.cleaned_data.get(<span class="string">'pwd'</span>)</span><br><span class="line">	r_pwd=self.cleaned_data.get(<span class="string">'r_pwd'</span>)</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> pwd <span class="keyword">and</span> r_pwd:</span><br><span class="line">		<span class="keyword">if</span> pwd==r_pwd:</span><br><span class="line">			<span class="keyword">return</span> self.cleaned_data</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">raise</span> ValidationError(<span class="string">'两次密码不一致'</span>)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> self.cleaned_data</span><br></pre></td></tr></table></figure>
<ul>
<li>全部文件</li>
</ul>
<p>①自定义forms组件</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.forms <span class="keyword">import</span> widgets</span><br><span class="line"><span class="keyword">from</span> app01.models <span class="keyword">import</span> UserInfo</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> NON_FIELD_ERRORS, ValidationError</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserForm</span><span class="params">(forms.Form)</span>:</span></span><br><span class="line">    name=forms.CharField(min_length=<span class="number">4</span>,label=<span class="string">"用户名"</span>,error_messages=&#123;<span class="string">"required"</span>:<span class="string">"该字段不能为空"</span>&#125;,</span><br><span class="line">                         widget=widgets.TextInput(attrs=&#123;<span class="string">"class"</span>:<span class="string">"form-control"</span>&#125;)</span><br><span class="line">                         )</span><br><span class="line">    pwd=forms.CharField(min_length=<span class="number">4</span>,label=<span class="string">"密码"</span>,</span><br><span class="line">                        widget=widgets.PasswordInput(attrs=&#123;<span class="string">"class"</span>:<span class="string">"form-control"</span>&#125;)</span><br><span class="line">                        )</span><br><span class="line">    r_pwd=forms.CharField(min_length=<span class="number">4</span>,label=<span class="string">"确认密码"</span>,error_messages=&#123;<span class="string">"required"</span>:<span class="string">"该字段不能为空"</span>&#125;,widget=widgets.TextInput(attrs=&#123;<span class="string">"class"</span>:<span class="string">"form-control"</span>&#125;))</span><br><span class="line">    email=forms.EmailField(label=<span class="string">"邮箱"</span>,error_messages=&#123;<span class="string">"required"</span>:<span class="string">"该字段不能为空"</span>,<span class="string">"invalid"</span>:<span class="string">"格式错误"</span>&#125;,widget=widgets.TextInput(attrs=&#123;<span class="string">"class"</span>:<span class="string">"form-control"</span>&#125;))</span><br><span class="line">    tel=forms.CharField(label=<span class="string">"手机号"</span>,widget=widgets.TextInput(attrs=&#123;<span class="string">"class"</span>:<span class="string">"form-control"</span>&#125;))</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_name</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        val=self.cleaned_data.get(<span class="string">"name"</span>)</span><br><span class="line"></span><br><span class="line">        ret=UserInfo.objects.filter(name=val)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ret:</span><br><span class="line">            <span class="keyword">return</span> val</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValidationError(<span class="string">"该用户已注册!"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean_tel</span><span class="params">(self)</span>:</span></span><br><span class="line"></span><br><span class="line">        val=self.cleaned_data.get(<span class="string">"tel"</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> len(val)==<span class="number">11</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> val</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span>  ValidationError(<span class="string">"手机号格式错误"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">clean</span><span class="params">(self)</span>:</span></span><br><span class="line">        pwd=self.cleaned_data.get(<span class="string">'pwd'</span>)</span><br><span class="line">        r_pwd=self.cleaned_data.get(<span class="string">'r_pwd'</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> pwd <span class="keyword">and</span> r_pwd:</span><br><span class="line">            <span class="keyword">if</span> pwd==r_pwd:</span><br><span class="line">                <span class="keyword">return</span> self.cleaned_data</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> ValidationError(<span class="string">'两次密码不一致'</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> self.cleaned_data</span><br></pre></td></tr></table></figure>
<p>②视图函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,HttpResponse</span><br><span class="line"><span class="keyword">from</span> app01.myforms <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># Create your views here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(request)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> request.method==<span class="string">"POST"</span>:</span><br><span class="line">        print(request.POST)</span><br><span class="line">        <span class="comment">#form=UserForm(&#123;"name":"yu","email":"123@qq.com","xxxx":"alex"&#125;)</span></span><br><span class="line">        form=UserForm(request.POST) <span class="comment"># form表单的name属性值应该与forms组件字段名称一致</span></span><br><span class="line">        print(form.is_valid()) <span class="comment"># 返回布尔值</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> form.is_valid():</span><br><span class="line">            print(form.cleaned_data)  <span class="comment"># &#123;"name":"yuan","email":"123@qq.com"&#125;</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            print(form.cleaned_data)  <span class="comment"># &#123;"email":"123@qq.com"&#125;</span></span><br><span class="line">            <span class="comment"># print(form.errors)        # &#123;"name":[".........."]&#125;</span></span><br><span class="line">            <span class="comment"># print(type(form.errors))  # ErrorDict</span></span><br><span class="line">            <span class="comment"># print(form.errors.get("name"))</span></span><br><span class="line">            <span class="comment"># print(type(form.errors.get("name")))    # ErrorList</span></span><br><span class="line">            <span class="comment"># print(form.errors.get("name")[0])</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">#   全局钩子错误</span></span><br><span class="line">            <span class="comment">#print("error",form.errors.get("__all__")[0])</span></span><br><span class="line">            errors=form.errors.get(<span class="string">"__all__"</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> render(request,<span class="string">"reg.html"</span>,locals())</span><br><span class="line"></span><br><span class="line">        <span class="string">'''</span></span><br><span class="line"><span class="string">        form.is_valid()   :返回布尔值</span></span><br><span class="line"><span class="string">        form.cleaned_data :&#123;"name":"yuan","email":"123@qq.com"&#125;</span></span><br><span class="line"><span class="string">        form.errors       :&#123;"name":[".........."]&#125;</span></span><br><span class="line"><span class="string">        '''</span></span><br><span class="line">    form=UserForm()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">"reg.html"</span>,locals())</span><br></pre></td></tr></table></figure>
<p>③模板文件</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Title<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="undefined"></span></span><br><span class="line"><span class="undefined">        .error&#123;</span></span><br><span class="line"><span class="undefined">            color: red;</span></span><br><span class="line"><span class="undefined">        &#125;</span></span><br><span class="line"><span class="undefined">    </span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 最新版本的 Bootstrap 核心 CSS 文件 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">integrity</span>=<span class="string">"sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"</span> <span class="attr">crossorigin</span>=<span class="string">"anonymous"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"container"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"row"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"col-md-6 col-lg-offset-3"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            &#123;#<span class="tag">&lt;<span class="name">h3</span>&gt;</span>简单form<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#    &#123;% csrf_token %&#125;#&#125;</span><br><span class="line">            &#123;#    <span class="tag">&lt;<span class="name">p</span>&gt;</span>用户名<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#    <span class="tag">&lt;<span class="name">p</span>&gt;</span>密码 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"pwd"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#    <span class="tag">&lt;<span class="name">p</span>&gt;</span>确认密码 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"r_pwd"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#    <span class="tag">&lt;<span class="name">p</span>&gt;</span>邮箱  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"email"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#    <span class="tag">&lt;<span class="name">p</span>&gt;</span>手机号 <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"tel"</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#<span class="tag">&lt;/<span class="name">form</span>&gt;</span>#&#125;</span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;<span class="name">hr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">h3</span>&gt;</span>forms组件渲染方式1<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>&gt;</span></span><br><span class="line"></span><br><span class="line">                &#123;% csrf_token %&#125;</span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; form.name.label &#125;&#125;</span><br><span class="line">                    &#123;&#123; form.name &#125;&#125; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right error"</span>&gt;</span>&#123;&#123; form.name.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>&#123;&#123; form.pwd.label &#125;&#125;</span><br><span class="line">                    &#123;&#123; form.pwd &#125;&#125; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right error"</span>&gt;</span>&#123;&#123; form.pwd.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>确认密码</span><br><span class="line">                    &#123;&#123; form.r_pwd &#125;&#125; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right error"</span>&gt;</span>&#123;&#123; form.r_pwd.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right error"</span>&gt;</span>&#123;&#123; errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>邮箱 &#123;&#123; form.email &#125;&#125; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right error"</span>&gt;</span>&#123;&#123; form.email.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">p</span>&gt;</span>手机号 &#123;&#123; form.tel &#125;&#125; <span class="tag">&lt;<span class="name">span</span> <span class="attr">class</span>=<span class="string">"pull-right error"</span>&gt;</span>&#123;&#123; form.tel.errors.0 &#125;&#125;<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">p</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"></span><br><span class="line">            &#123;#<span class="tag">&lt;<span class="name">h3</span>&gt;</span>forms组件渲染方式2<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span> <span class="attr">novalidate</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#     &#123;% csrf_token %&#125;#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#    &#123;% for field in form %&#125;#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#        <span class="tag">&lt;<span class="name">div</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#            <span class="tag">&lt;<span class="name">label</span> <span class="attr">for</span>=<span class="string">""</span>&gt;</span>&#123;&#123; field.label &#125;&#125;<span class="tag">&lt;/<span class="name">label</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#            &#123;&#123; field &#125;&#125;#&#125;</span><br><span class="line">            &#123;#        <span class="tag">&lt;/<span class="name">div</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#    &#123;% endfor %&#125;#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#     <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#<span class="tag">&lt;/<span class="name">form</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#<span class="tag">&lt;<span class="name">h3</span>&gt;</span>forms组件渲染方式3<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#<span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">""</span> <span class="attr">method</span>=<span class="string">"post"</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#     &#123;% csrf_token %&#125;#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#     &#123;&#123; form.as_p &#125;&#125;#&#125;</span><br><span class="line">            &#123;##&#125;</span><br><span class="line">            &#123;#     <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span>#&#125;</span><br><span class="line">            &#123;#<span class="tag">&lt;/<span class="name">form</span>&gt;</span>#&#125;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="4-cookie和session"><a href="#4-cookie和session" class="headerlink" title="4.cookie和session"></a>4.cookie和session</h2><ul>
<li>COOKIE</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Cookie：保存在浏览器端的键值对（应用：登录认证）</span><br><span class="line">Cookie的工作原理是：由服务器产生内容，浏览器收到请求后保存在本地；当浏览器再次访问时，浏览器会自动带上Cookie，这样服务器就能通过Cookie的内容来判断这个是“谁”了。</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------</span><br><span class="line">obj=HttpResponse()</span><br><span class="line">    存cookie: obj.set_cookie(key,value,max_age(IE浏览器版本低不认识)/expires)</span><br><span class="line">              obj.set_signed_cookie() <span class="comment"># 设置加密方式的cookie;</span></span><br><span class="line">    删除COOKIE:obj.delete_cookie()   <span class="comment"># 删除用户浏览器上之前设置的usercookie值</span></span><br><span class="line">    取COOKIE：request.COOKIES.get(key)</span><br><span class="line">        	 request.get_signed_cookie()  <span class="comment"># 敏感信息还是在前端可以看到</span></span><br><span class="line">----------------------------------------------------------</span><br><span class="line">csrf_token 也是在cookie中的，客户端/服务端均可设置</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Cookie规范</span><br><span class="line">	Cookie大小上限为4KB； </span><br><span class="line">	一个服务器最多在客户端浏览器上保存20个Cookie； </span><br><span class="line">	一个浏览器最多保存300个Cookie；</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">cookie参数</span><br><span class="line"></span><br><span class="line">	①key, 键</span><br><span class="line">	②value=&apos;&apos;, 值</span><br><span class="line">	④max_age=None, 超时时间 cookie需要延续的时间（以秒为单位）如果参数是\ None`` ，这个cookie会延续到浏览器关闭为止</span><br><span class="line">	⑤expires=None, 超时时间(IE requires expires, so set it if hasn&apos;t been already.)</span><br><span class="line">	⑥path=&apos;/&apos;, Cookie生效的路径，/ 表示根路径，特殊的：根路径的cookie可以被任何url的页面访问，浏览器只会把cookie回传给带有该路径的页面，这样可以避免将cookie传给站点中的其他的应用。</span><br><span class="line">	⑦domain=None, Cookie生效的域名 你可用这个参数来构造一个跨站cookie。如， domain=&quot;.example.com&quot;所构造的cookie对下面这些站点都是可读的：www.example.com 、 www2.example.com 和an.other.sub.domain.example.com 。如果该参数设置为 None ，cookie只能由设置它的站点读取</span><br><span class="line">	⑧secure=False, 浏览器将通过HTTPS来回传cookie</span><br><span class="line">	⑨httponly=False 只能http协议传输，无法被JavaScript获取（不是绝对，底层抓包可以获取到也可以被覆盖）</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Cookie登录检验+装饰器</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login_auth</span><span class="params">(func)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">inner</span><span class="params">(request,*args,**kwargs)</span>:</span></span><br><span class="line">        next_url=request.get_full_path()</span><br><span class="line">        <span class="keyword">if</span> request.COOKIES.get(<span class="string">'is_login'</span>):</span><br><span class="line">            <span class="keyword">return</span> func(request,*args,**kwargs)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> redirect(<span class="string">'cookie_login/?next=%s'</span>%next_url)</span><br><span class="line">    <span class="keyword">return</span> inner</span><br><span class="line"><span class="meta">@login_auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cookie_order</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'我是订单页面'</span>)</span><br><span class="line"><span class="meta">@login_auth</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cookie_index</span><span class="params">(request)</span>:</span></span><br><span class="line">    name=request.COOKIES.get(<span class="string">'username'</span>)</span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'cookie_index.html'</span>,&#123;<span class="string">'name'</span>:name&#125;)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">cookie_login</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> request.method ==<span class="string">'POST'</span>:</span><br><span class="line">        next_url=request.GET.get(<span class="string">'next'</span>)</span><br><span class="line">        name=request.POST.get(<span class="string">'name'</span>)</span><br><span class="line">        password=request.POST.get(<span class="string">'password'</span>)</span><br><span class="line">        <span class="keyword">if</span> name == <span class="string">'lqz'</span> <span class="keyword">and</span> password == <span class="string">'123'</span>:</span><br><span class="line">            <span class="keyword">import</span> datetime</span><br><span class="line">            now=datetime.datetime.now().strftime(<span class="string">'%Y-%m-%d %X'</span>)</span><br><span class="line">            print(now)</span><br><span class="line">            obj=redirect(next_url)</span><br><span class="line">            obj.set_cookie(<span class="string">'is_login'</span>,<span class="keyword">True</span>)</span><br><span class="line">            obj.set_cookie(<span class="string">'username'</span>,name)</span><br><span class="line">            obj.set_cookie(<span class="string">'login_time'</span>,now)</span><br><span class="line">            <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'cookie_login.html'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>session</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">Session（字典的操作session基本都满足）：保存在服务端的键值对,内部机制依赖于cookie</span><br><span class="line"></span><br><span class="line">Session一般在很多页面都需要用到,所有可以用装饰器的方式来对多个函数进行装饰,减少重复代码</span><br><span class="line"></span><br><span class="line">存：request.session[key]=value</span><br><span class="line">取：request.session.get(key)</span><br><span class="line">    request.session.iterkeys(), 不会直接取出值,只会在循环迭代时取值</span><br><span class="line">    request.session.session_key, 当前用户session的随机字符串</span><br><span class="line">    request.session.clear_expired(), 清除所有session已过期的数据</span><br><span class="line">    request.session.exists(<span class="string">"key"</span>), 检查当期那用户session是否在数据库中</span><br><span class="line">    request.session.delete(<span class="string">"key"</span>), 删除当前用户session数据</span><br><span class="line">    清除除session：request.session.clear()</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 所有 键、值、键值对</span></span><br><span class="line">request.session.keys()</span><br><span class="line">request.session.values()</span><br><span class="line">request.session.items()</span><br><span class="line">request.session.iterkeys()</span><br><span class="line">request.session.itervalues()</span><br><span class="line">request.session.iteritems()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">settings.py</span><br><span class="line"></span><br><span class="line"><span class="number">1.</span> 数据库Session</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.db'</span>   <span class="comment"># 引擎（默认）</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span> 缓存Session</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.cache'</span>  <span class="comment"># 引擎</span></span><br><span class="line">SESSION_CACHE_ALIAS = <span class="string">'default'</span>                            <span class="comment"># 使用的缓存别名（默认内存缓存，也可以是memcache），此处别名依赖缓存的设置</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.</span> 文件Session</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.file'</span>    <span class="comment"># 引擎</span></span><br><span class="line">SESSION_FILE_PATH = <span class="keyword">None</span>                                    <span class="comment"># 缓存文件路径，如果为None，则使用tempfile模块获取一个临时地址tempfile.gettempdir() </span></span><br><span class="line"></span><br><span class="line"><span class="number">4.</span> 缓存+数据库</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.cached_db'</span>        <span class="comment"># 引擎</span></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span> 加密Cookie Session</span><br><span class="line">SESSION_ENGINE = <span class="string">'django.contrib.sessions.backends.signed_cookies'</span>   <span class="comment"># 引擎</span></span><br><span class="line"></span><br><span class="line">其他公用设置项：</span><br><span class="line">SESSION_COOKIE_NAME ＝ <span class="string">"sessionid"</span>                       <span class="comment"># Session的cookie保存在浏览器上时的key，即：sessionid＝随机字符串（默认）</span></span><br><span class="line">SESSION_COOKIE_PATH ＝ <span class="string">"/"</span>                               <span class="comment"># Session的cookie保存的路径（默认）</span></span><br><span class="line">SESSION_COOKIE_DOMAIN = <span class="keyword">None</span>                             <span class="comment"># Session的cookie保存的域名（默认）</span></span><br><span class="line">SESSION_COOKIE_SECURE = <span class="keyword">False</span>                            <span class="comment"># 是否Https传输cookie（默认）</span></span><br><span class="line">SESSION_COOKIE_HTTPONLY = <span class="keyword">True</span>                           <span class="comment"># 是否Session的cookie只支持http传输（默认）</span></span><br><span class="line">SESSION_COOKIE_AGE = <span class="number">1209600</span>                             <span class="comment"># Session的cookie失效日期（2周）（默认）</span></span><br><span class="line">SESSION_EXPIRE_AT_BROWSER_CLOSE = <span class="keyword">False</span>                  <span class="comment"># 是否关闭浏览器使得Session过期（默认）</span></span><br><span class="line">SESSION_SAVE_EVERY_REQUEST = <span class="keyword">False</span>                       <span class="comment"># 是否每次请求都保存Session，默认修改之后才保存（默认）</span></span><br></pre></td></tr></table></figure>
<ul>
<li>CBV 加装饰器</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> django.utils.decorators <span class="keyword">import</span> method_decorator</span><br><span class="line"><span class="comment"># @method_decorator(login_auth,name='get')</span></span><br><span class="line"><span class="comment"># @method_decorator(login_auth,name='post')</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserList</span><span class="params">(views.View)</span>:</span></span><br><span class="line">    <span class="comment"># @method_decorator(login_auth)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        obj=super().dispatch(request, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> obj</span><br><span class="line"></span><br><span class="line"><span class="meta">    @method_decorator(login_auth)</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'我是用户列表'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'我是用户列表'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="5-中间件"><a href="#5-中间件" class="headerlink" title="5.中间件"></a>5.中间件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">中间件，是介于request与response处理之间的一道处理过程，相对比较轻量级，并且在全局上改变django的输入与输出。</span><br></pre></td></tr></table></figure>
<ul>
<li>settings.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">	<span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">	<span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line">	<span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line">	<span class="string">'django.middleware.csrf.CsrfViewMiddleware'</span>,			<span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</span><br><span class="line">    <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>自定义中间件（MyMiddlewares.py）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> HttpResponse</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMiddleware1</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        print(<span class="string">"MyMiddleware1请求"</span>)</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self,request,response)</span>:</span></span><br><span class="line">        print(<span class="string">"MyMiddleware1返回"</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyMiddleware2</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_request</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        print(<span class="string">"MyMiddleware2请求"</span>)</span><br><span class="line">        <span class="comment">#return HttpResponse("Md2中断")</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self,request,response)</span>:</span></span><br><span class="line">        print(<span class="string">"MyMiddleware2返回"</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<ul>
<li>views.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    print(<span class="string">"view函数..."</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"OK"</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>settins.py中注册自定义中间件</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line">    <span class="string">"..."</span>,</span><br><span class="line">    <span class="string">"MyMiddlewares.MyMiddleware1"</span>,</span><br><span class="line">    <span class="string">"MyMiddlewares.MyMiddleware2"</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>中间件中的几个方法（主要用到request和response）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">process_request(self,request)</span><br><span class="line"></span><br><span class="line">process_view(self, request, callback, callback_args, callback_kwargs)</span><br><span class="line"></span><br><span class="line">process_template_response(self,request,response)</span><br><span class="line"></span><br><span class="line">process_exception(self, request, exception)</span><br><span class="line"></span><br><span class="line">process_response(self, request, response)</span><br></pre></td></tr></table></figure>
<ul>
<li>中间件和视图函数的联系</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">	中间件的process_request方法是在执行视图函数之前执行的。</span><br><span class="line">	当配置多个中间件时，会按照MIDDLEWARE中的注册顺序，也就是列表的索引值，从前到后依次执行的。</span><br><span class="line">	不同中间件之间传递的request都是同一个对象</span><br><span class="line">	</span><br><span class="line">总结：</span><br><span class="line">	多个中间件中的process_response方法是按照MIDDLEWARE中的注册顺序倒序执行的，也就是说第一个中间件的process_request方法首先执行，而它的process_response方法最后执行，最后一个中间件的process_request方法最后一个执行，它的process_response方法是最先执行。</span><br></pre></td></tr></table></figure>
<ul>
<li>中间件的应用</li>
</ul>
<p>① IP频率限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">某些IP访问服务器的频率过高，进行拦截，比如限制每分钟不能超过20次。</span><br></pre></td></tr></table></figure>
<p>② URL访问过滤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">假设用户访问的是login视图（可以通过）</span><br><span class="line"></span><br><span class="line">但是访问其他视图，需要检测是不是有session认证，已经有了放行，没有返回login，这样就省得在多个视图函数上写装饰器了！</span><br><span class="line"></span><br><span class="line">&apos;django.contrib.sessions.middleware.SessionMiddleware&apos;,</span><br><span class="line">&apos;django.contrib.auth.middleware.AuthenticationMiddleware&apos;,</span><br></pre></td></tr></table></figure>
<h3 id="CSRF-TOKEN跨站请求伪造"><a href="#CSRF-TOKEN跨站请求伪造" class="headerlink" title="CSRF_TOKEN跨站请求伪造"></a>CSRF_TOKEN跨站请求伪造</h3><ul>
<li>定义</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">一种对网站的恶意利用，尽管听起来像跨站脚本（XSS），但它与XSS非常不同，XSS利用站点内的信任用户，而CSRF则通过伪装来自受信任用户的请求来利用受信任的网站。与XSS攻击相比，CSRF攻击往往不大流行（因此对其进行防范的资源也相当稀少）和难以防范，所以被认为比XSS更具危险性</span><br></pre></td></tr></table></figure>
<ul>
<li>CSRF攻击防范</li>
</ul>
<p>①方式一：验证 HTTP Referer 字段 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">	在 HTTP 头中有一个字段叫 Referer，它记录了该 HTTP 请求的来源地址。若 Referer 中记录的不是指向自己网站，则认为是 CSRF 攻击，拒绝该访问。</span><br><span class="line">优点：</span><br><span class="line">	简单易行，网站的普通开发人员不需要操心 CSRF 的漏洞，只需要在最后给所有安全敏感的请求统一增加一个拦截器来检查 Referer 的值就可以。</span><br><span class="line">缺点：</span><br><span class="line">	Referer 值会记录用户的访问来源，用户认为这样会侵犯到隐私权，特别是有些组织担心 Referer 值会把组织内网中的某些信息泄露到外网中。因此，用户可以设置浏览器使其在发送请求时不再提供 Referer。当他们正常访问银行网站时，网站会因为请求没有 Referer 值而认为是 CSRF 攻击，拒绝合法用户的访问。</span><br></pre></td></tr></table></figure>
<p>②方式二：在请求地址中添加 token 并验证 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">这种方法要比检查 Referer 要安全一些，token 可以在用户登录后产生并放于 session 之中，然后在每次请求时把 token 从 session 中拿出，与请求中的 token 进行比对，但这种方法的难点在于如何把 token 以参数的形式加入请求。</span><br><span class="line">对于 GET 请求，token 将附在请求地址之后，这样 URL 就变成 http://url?csrftoken=tokenvalue。</span><br><span class="line">对于 POST 请求来说，要在 form 的最后加上 &lt;input type=”hidden” name=”csrftoken” value=”tokenvalue”/&gt;，这样就把 token 以参数的形式加入请求了。</span><br><span class="line">但是，在一个网站中，可以接受请求的地方非常多，要对于每一个请求都加上 token 是很麻烦的，并且很容易漏掉，通常使用的方法就是在每次页面加载时，使用 javascript 遍历整个 dom 树，对于 dom 中所有的 a 和 form 标签后加入 token。这样可以解决大部分的请求，但是对于在页面加载之后动态生成的 html 代码，这种方法就没有作用，还需要程序员在编码时手动添加 token。</span><br></pre></td></tr></table></figure>
<p>③方式三：在 HTTP 头中自定义属性并验证 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这里并不是把 token 以参数的形式置于 HTTP 请求之中，而是把它放到 HTTP 头中自定义的属性里。通过 XMLHttpRequest 这个类，可以一次性给所有该类请求加上 csrftoken 这个 HTTP 头属性，并把 token 值放入其中。这样解决了上种方法在请求中加入 token 的不便，同时，通过 XMLHttpRequest 请求的地址不会被记录到浏览器的地址栏，也不用担心 token 会透过 Referer 泄露到其他网站中去。</span><br></pre></td></tr></table></figure>
<h2 id="6-Auth模块（Django自带的用户认证模块）"><a href="#6-Auth模块（Django自带的用户认证模块）" class="headerlink" title="6.Auth模块（Django自带的用户认证模块）"></a>6.Auth模块（Django自带的用户认证模块）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib <span class="keyword">import</span> auth</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="authenticate"><a href="#authenticate" class="headerlink" title="authenticate()"></a>authenticate()</h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user = authenticate(username=&apos;usernamer&apos;,password=&apos;password&apos;)</span><br><span class="line">用户认证功能，即验证用户名以及密码是否正确，一般需要username 、password两个关键字参数。认证成功（用户名和密码正确有效），便会返回一个 User 对象。authenticate()会在该 User 对象上设置一个属性来标识后端已经认证了该用户，且该信息在后续的登录过程中是需要的。</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="login-HttpRequest-user"><a href="#login-HttpRequest-user" class="headerlink" title="login(HttpRequest, user)"></a>login(HttpRequest, user)</h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">函数接受一个HttpRequest对象，以及一个经过认证的User对象。实现一个用户登录的功能。它本质上会在后端为该用户生成相关session数据。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> authenticate, login</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_view</span><span class="params">(request)</span>:</span></span><br><span class="line">    username = request.POST[<span class="string">'username'</span>]</span><br><span class="line">    password = request.POST[<span class="string">'password'</span>]</span><br><span class="line">    user = authenticate(username=username, password=password)</span><br><span class="line">    <span class="keyword">if</span> user <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">        login(request, user)</span><br><span class="line">        <span class="comment"># Redirect to a success page.</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="comment"># Return an 'invalid login' error message.</span></span><br><span class="line">        ...</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="logout-request"><a href="#logout-request" class="headerlink" title="logout(request)"></a><strong>logout(request)</strong></h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">函数接受一个HttpRequest对象，无返回值。用该函数时，当前请求的session信息会全部清除。该用户即使没有登录，使用该函数也不会报错。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> logout</span><br><span class="line">   </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">logout_view</span><span class="params">(request)</span>:</span></span><br><span class="line">  logout(request)</span><br><span class="line">  <span class="comment"># Redirect to a success page.</span></span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="is-authenticated"><a href="#is-authenticated" class="headerlink" title="is_authenticated()"></a>is_authenticated()</h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">用来判断当前请求是否通过了认证。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_view</span><span class="params">(request)</span>:</span></span><br><span class="line">	<span class="keyword">if</span> <span class="keyword">not</span> request.user.is_authenticated():</span><br><span class="line">		<span class="keyword">return</span> redirect(<span class="string">'%s?next=%s'</span> % (settings.LOGIN_URL, request.path))</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="login-requierd"><a href="#login-requierd" class="headerlink" title="login_requierd()"></a>login_requierd()</h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">auth 给我们提供的一个装饰器工具，用来快捷的给某个视图添加登录校验。</span><br><span class="line">若用户没有登录，则会跳转到django默认的 登录URL &apos;/accounts/login/ &apos; 并传递当前访问url的绝对路径 (登陆成功后，会重定向到该路径)。</span><br><span class="line"></span><br><span class="line">如果需要自定义登录的URL，则需要在settings.py文件中通过LOGIN_URL进行修改。</span><br><span class="line"></span><br><span class="line">LOGIN_URL = &apos;/login/&apos;  # 这里配置成你项目登录页面的路由</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.decorators <span class="keyword">import</span> login_required</span><br><span class="line">      </span><br><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_view</span><span class="params">(request)</span>:</span></span><br><span class="line">  ...</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="create-user"><a href="#create-user" class="headerlink" title="create_user()"></a>create_user()</h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth 提供的一个创建新用户的方法，需要提供必要参数（username、password）等。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line">user = User.objects.create_user（username=<span class="string">'用户名'</span>,password=<span class="string">'密码'</span>,email=<span class="string">'邮箱'</span>,...）</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="create-superuser"><a href="#create-superuser" class="headerlink" title="create_superuser()"></a>create_superuser()</h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth 提供的一个创建新的超级用户的方法，需要提供必要参数（username、password）等。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> User</span><br><span class="line">user = User.objects.create_superuser（username=<span class="string">'用户名'</span>,password=<span class="string">'密码'</span>,email=<span class="string">'邮箱'</span>,...）</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="check-password-password"><a href="#check-password-password" class="headerlink" title="check_password(password)"></a>check_password(password)</h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">auth 提供的一个检查密码是否正确的方法，需要提供当前请求用户的密码。密码正确返回True，否则返回False。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res = user.check_password(<span class="string">'密码'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="set-password-password"><a href="#set-password-password" class="headerlink" title="set_password(password)"></a>set_password(password)</h3></li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">auth 提供的一个修改密码的方法，接收 要设置的新密码 作为参数。</span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 注意 --&gt;</span></span><br><span class="line">设置完一定要调用用户对象的save方法！！！</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@login_required</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_password</span><span class="params">(request)</span>:</span></span><br><span class="line">    user = request.user</span><br><span class="line">    err_msg = <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</span><br><span class="line">        old_password = request.POST.get(<span class="string">'old_password'</span>, <span class="string">''</span>)</span><br><span class="line">        new_password = request.POST.get(<span class="string">'new_password'</span>, <span class="string">''</span>)</span><br><span class="line">        repeat_password = request.POST.get(<span class="string">'repeat_password'</span>, <span class="string">''</span>)</span><br><span class="line">        <span class="comment"># 检查旧密码是否正确</span></span><br><span class="line">        <span class="keyword">if</span> user.check_password(old_password):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> new_password:</span><br><span class="line">                err_msg = <span class="string">'新密码不能为空'</span></span><br><span class="line">            <span class="keyword">elif</span> new_password != repeat_password:</span><br><span class="line">                err_msg = <span class="string">'两次密码不一致'</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                user.set_password(new_password)  <span class="comment"># 设置密码</span></span><br><span class="line">                user.save()                 <span class="comment"># 一定要保存</span></span><br><span class="line">                <span class="keyword">return</span> redirect(<span class="string">"/login/"</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            err_msg = <span class="string">'原密码输入错误'</span></span><br><span class="line">    content = &#123;</span><br><span class="line">        <span class="string">'err_msg'</span>: err_msg,</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> render(request, <span class="string">'set_password.html'</span>, content)</span><br></pre></td></tr></table></figure>
<ul>
<li><h3 id="User对象的属性"><a href="#User对象的属性" class="headerlink" title="User对象的属性"></a>User对象的属性</h3></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">User对象属性：username， password</span><br><span class="line">is_staff ： 用户是否拥有网站的管理权限.</span><br><span class="line"></span><br><span class="line">is_active ： 是否允许用户登录, 设置为 False，可以在不删除用户的前提下禁止用户登录。</span><br></pre></td></tr></table></figure>
<h3 id="扩展auth-user表"><a href="#扩展auth-user表" class="headerlink" title="扩展auth_user表"></a>扩展auth_user表</h3><ul>
<li>自定义Model类，继承AbstractUser类，又能使用Django强大的认证系统了</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.models <span class="keyword">import</span> AbstractUser</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(AbstractUser)</span>:</span></span><br><span class="line">    <span class="string">"""用户信息表"""</span></span><br><span class="line">    nid = models.AutoField(primary_key=<span class="keyword">True</span>)</span><br><span class="line">    phone = models.CharField(max_length=<span class="number">11</span>, null=<span class="keyword">True</span>, unique=<span class="keyword">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.username</span><br><span class="line">    </span><br><span class="line"><span class="comment"># 注意</span></span><br><span class="line">	扩展了内置的auth_user表之后，一定要在settings.py中告诉Django，我现在使用我新定义的UserInfo表来做用户认证。</span><br><span class="line">    一旦我们指定了新的认证系统所使用的表，我们就需要重新在数据库中创建该表，而不能继续使用原来默认的auth_user表了。</span><br><span class="line"></span><br><span class="line"><span class="comment"># 引用Django自带的User表，继承使用时需要设置</span></span><br><span class="line">AUTH_USER_MODEL = <span class="string">"app名.UserInfo"</span></span><br></pre></td></tr></table></figure>
<h2 id="7-ContentType（Django提供的ContentType表-）"><a href="#7-ContentType（Django提供的ContentType表-）" class="headerlink" title="7.ContentType（Django提供的ContentType表 ）"></a>7.ContentType（Django提供的ContentType表 ）</h2><ul>
<li>models.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.models <span class="keyword">import</span> ContentType</span><br><span class="line"><span class="keyword">from</span> django.contrib.contenttypes.fields <span class="keyword">import</span> GenericForeignKey, GenericRelation</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    <span class="comment"># 不会在数据库中生成字段，只用于数据库操作</span></span><br><span class="line">    <span class="comment"># policy = GenericRelation('PricePolicy',object_id_field='object_id',content_type_field='contentType')</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DegreeCourse</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PricePolicy</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># 跟Django提供的ContentType表做外键关联</span></span><br><span class="line">    contentType = models.ForeignKey(to=ContentType)</span><br><span class="line">    <span class="comment"># 正数</span></span><br><span class="line">    object_id = models.PositiveIntegerField()</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 引入一个字段，不会在数据库中创建，只用来做数据库操作</span></span><br><span class="line">    <span class="comment"># content_obj = GenericForeignKey('contentType', 'object_id')</span></span><br><span class="line">    period = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    price = models.FloatField()</span><br></pre></td></tr></table></figure>
<ul>
<li>views.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> models</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> json</span><br><span class="line">    <span class="comment"># 方式一插入价格规则</span></span><br><span class="line">    <span class="comment"># ret=models.ContentType.objects.filter(model='course').first()</span></span><br><span class="line">    <span class="comment"># course=models.Course.objects.filter(pk=1).first()</span></span><br><span class="line">    <span class="comment"># print(ret.id)</span></span><br><span class="line">    <span class="comment"># models.PricePolicy.objects.create(period='30',price=100,object_id=course.id,contentType_id=ret.id)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 方式二插入价格规则</span></span><br><span class="line">    <span class="comment"># course=models.Course.objects.filter(pk=1).first()</span></span><br><span class="line">    <span class="comment"># # content_obj=course  会自动的把课程id放到object_id上，并且去ContentType表中查询课程表的id，放到contentType上</span></span><br><span class="line">    <span class="comment"># models.PricePolicy.objects.create(period='60',price=800,content_obj=course)</span></span><br><span class="line">    <span class="comment"># 增加学位课，价格规则</span></span><br><span class="line">    <span class="comment"># degreecourse = models.DegreeCourse.objects.filter(pk=1).first()</span></span><br><span class="line">    <span class="comment"># models.PricePolicy.objects.create(period='60', price=800, content_obj=degreecourse)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 查询所有价格策略，并且显示对应的课程名称</span></span><br><span class="line">    <span class="comment"># ret=models.PricePolicy.objects.all()</span></span><br><span class="line">    <span class="comment"># for i in ret:</span></span><br><span class="line">    <span class="comment">#     print(i.price)</span></span><br><span class="line">    <span class="comment">#     print(i.period)</span></span><br><span class="line">    <span class="comment">#     # content_obj 就是代指关联的课程，或者学位课程的那个对象</span></span><br><span class="line">    <span class="comment">#     print(type(i.content_obj))</span></span><br><span class="line">    <span class="comment">#     print(i.content_obj.title)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 通过课程id，获取课程信息和价格策略</span></span><br><span class="line">    course=models.Course.objects.filter(pk=<span class="number">1</span>).first()</span><br><span class="line">    print(course.policy.all())</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> render(request,<span class="string">'test.html'</span>)</span><br></pre></td></tr></table></figure>
<h1 id="七、Rest-Framework"><a href="#七、Rest-Framework" class="headerlink" title="七、Rest Framework"></a>七、Rest Framework</h1><h2 id="1-RESTful规范"><a href="#1-RESTful规范" class="headerlink" title="1.RESTful规范"></a>1.RESTful规范</h2><ul>
<li>定义：</li>
</ul>
<p>①REST是一种软件架构风格，REST是Representational State Transfer的简称，中文翻译为“表征状态转移”</p>
<p>②所有的数据，不过是通过网络获取的还是操作（增删改查）的数据，都是资源，将一切数据视为资源是REST区别与其他架构风格的最本质属性</p>
<p>③REST从资源的角度类审视整个网络，它将分布在网络中某个节点的资源通过URL进行标识，客户端应用通过URL来获取资源的表征，获得这些表征致使这些应用转变状态</p>
<ul>
<li>RESTful API设计</li>
</ul>
<p>①API与用户的通信协议，总是使用[HTTPs协议</p>
<p>②域名 </p>
<p>​    <a href="https://api.example.com" target="_blank" rel="noopener">https://api.example.com</a>   —尽量将API部署在专用域名(会存在跨域问题) </p>
<p>​    <a href="https://example.org/api/" target="_blank" rel="noopener">https://example.org/api/</a>      —API很简单 </p>
<p>③路径，视网络上任何东西都是资源，均使用名词表示（可复数） </p>
<ul>
<li><a href="https://api.example.com/zoos" target="_blank" rel="noopener">https://api.example.com/zoos</a></li>
</ul>
<p>④method </p>
<table>
<thead>
<tr>
<th>METHOD</th>
<th style="text-align:left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td style="text-align:left">从服务器取出资源（一项或多项）</td>
</tr>
<tr>
<td>POST</td>
<td style="text-align:left">在服务器新建一个资源</td>
</tr>
<tr>
<td>PUT</td>
<td style="text-align:left">在服务器更新资源（客户端提供改变后的完整资源）</td>
</tr>
<tr>
<td>PATCH</td>
<td style="text-align:left">在服务器更新资源（客户端提供改变的属性）</td>
</tr>
<tr>
<td>DELETE</td>
<td style="text-align:left">从服务器删除资源</td>
</tr>
</tbody>
</table>
<p>⑤过滤，通过在url上传参的形式传递搜索条件 </p>
<ul>
<li><a href="https://api.example.com/v1/zoos?limit=10：指定返回记录的数量" target="_blank" rel="noopener">https://api.example.com/v1/zoos?limit=10：指定返回记录的数量</a></li>
<li><a href="https://api.example.com/v1/zoos?offset=10：指定返回记录的开始位置" target="_blank" rel="noopener">https://api.example.com/v1/zoos?offset=10：指定返回记录的开始位置</a></li>
<li><a href="https://api.example.com/v1/zoos?page=2&amp;per_page=100：指定第几页，以及每页的记录数" target="_blank" rel="noopener">https://api.example.com/v1/zoos?page=2&amp;per_page=100：指定第几页，以及每页的记录数</a></li>
</ul>
<p>⑥状态码 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">200 OK - [GET]：服务器成功返回用户请求的数据，该操作是幂等的（Idempotent）。</span><br><span class="line">201 CREATED - [POST/PUT/PATCH]：用户新建或修改数据成功。</span><br><span class="line">202 Accepted - [*]：表示一个请求已经进入后台排队（异步任务）</span><br><span class="line">204 NO CONTENT - [DELETE]：用户删除数据成功。</span><br><span class="line">400 INVALID REQUEST - [POST/PUT/PATCH]：用户发出的请求有错误，服务器没有进行新建或修改数据的操作，该操作是幂等的。</span><br><span class="line">401 Unauthorized - [*]：表示用户没有权限（令牌、用户名、密码错误）。</span><br><span class="line">403 Forbidden - [*] 表示用户得到授权（与401错误相对），但是访问是被禁止的。</span><br><span class="line">404 NOT FOUND - [*]：用户发出的请求针对的是不存在的记录，服务器没有进行操作，该操作是幂等的。</span><br><span class="line">406 Not Acceptable - [GET]：用户请求的格式不可得（比如用户请求JSON格式，但是只有XML格式）。</span><br><span class="line">410 Gone -[GET]：用户请求的资源被永久删除，且不会再得到的。</span><br><span class="line">422 Unprocesable entity - [POST/PUT/PATCH] 当创建一个对象时，发生一个验证错误。</span><br><span class="line">500 INTERNAL SERVER ERROR - [*]：服务器发生错误，用户将无法判断发出的请求是否成功。</span><br></pre></td></tr></table></figure>
<p>⑦返回结果，针对不同操作，服务器向用户返回的结果应该符合以下规范。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">GET /collection：返回资源对象的列表（数组）</span><br><span class="line">GET /collection/resource：返回单个资源对象</span><br><span class="line">POST /collection：返回新生成的资源对象</span><br><span class="line">PUT /collection/resource：返回完整的资源对象</span><br><span class="line">PATCH /collection/resource：返回完整的资源对象</span><br><span class="line">DELETE /collection/resource：返回一个空文档</span><br></pre></td></tr></table></figure>
<p>⑧错误处理，应返回错误信息，error当做key。  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    error: "Invalid API key"</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>⑨Hypermedia API，RESTful API最好做到Hypermedia，即返回结果中提供链接，连向其他API方法，使得用户不查文档，也知道下一步应该做什么。 </p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&#123;<span class="attr">"link"</span>: &#123;</span><br><span class="line">  <span class="attr">"rel"</span>:   <span class="string">"collection https://www.example.com/zoos"</span>,</span><br><span class="line">  <span class="attr">"href"</span>:  <span class="string">"https://api.example.com/zoos"</span>,</span><br><span class="line">  <span class="attr">"title"</span>: <span class="string">"List of zoos"</span>,</span><br><span class="line">  <span class="attr">"type"</span>:  <span class="string">"application/vnd.yourformat+json"</span></span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>⑩版本</p>
<p>URL，如：<a href="https://api.example.com/v1/" target="_blank" rel="noopener">https://api.example.com/v1/</a></p>
<h2 id="2-APIView"><a href="#2-APIView" class="headerlink" title="2.APIView"></a>2.APIView</h2><ul>
<li>安装</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">方式一：pip3 install djangorestframework</span><br><span class="line">方式二：pycharm图形化界面安装</span><br><span class="line">方式三：pycharm命令行下安装（装在当前工程所用的解释器下）</span><br></pre></td></tr></table></figure>
<ul>
<li>Djangorestframework的APIView分析</li>
</ul>
<p>① as_view()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@classmethod</span></span><br><span class="line">   <span class="function"><span class="keyword">def</span> <span class="title">as_view</span><span class="params">(cls, **initkwargs)</span>:</span></span><br><span class="line">       <span class="string">"""</span></span><br><span class="line"><span class="string">       Store the original class on the view function.</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">       This allows us to discover information about the view when we do URL</span></span><br><span class="line"><span class="string">       reverse lookups.  Used for breadcrumb generation.</span></span><br><span class="line"><span class="string">       """</span></span><br><span class="line">       <span class="keyword">if</span> isinstance(getattr(cls, <span class="string">'queryset'</span>, <span class="keyword">None</span>), models.query.QuerySet):</span><br><span class="line">           <span class="function"><span class="keyword">def</span> <span class="title">force_evaluation</span><span class="params">()</span>:</span></span><br><span class="line">               <span class="keyword">raise</span> RuntimeError(</span><br><span class="line">                   <span class="string">'Do not evaluate the `.queryset` attribute directly, '</span></span><br><span class="line">                   <span class="string">'as the result will be cached and reused between requests. '</span></span><br><span class="line">                   <span class="string">'Use `.all()` or call `.get_queryset()` instead.'</span></span><br><span class="line">               )</span><br><span class="line">           cls.queryset._fetch_all = force_evaluation</span><br><span class="line"></span><br><span class="line">       view = super(APIView, cls).as_view(**initkwargs)</span><br><span class="line">       view.cls = cls</span><br><span class="line">       view.initkwargs = initkwargs</span><br><span class="line"></span><br><span class="line">       <span class="comment"># Note: session based authentication is explicitly CSRF validated,</span></span><br><span class="line">       <span class="comment"># all other authentication is CSRF exempt.</span></span><br><span class="line">       <span class="keyword">return</span> csrf_exempt(view)</span><br></pre></td></tr></table></figure>
<p>②dispatch()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">dispatch</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        `.dispatch()` is pretty much the same as Django's regular dispatch,</span></span><br><span class="line"><span class="string">        but with extra hooks for startup, finalize, and exception handling.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.args = args</span><br><span class="line">        self.kwargs = kwargs</span><br><span class="line">        request = self.initialize_request(request, *args, **kwargs)</span><br><span class="line">        self.request = request</span><br><span class="line">        self.headers = self.default_response_headers  <span class="comment"># deprecate?</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            self.initial(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Get the appropriate handler method</span></span><br><span class="line">            <span class="keyword">if</span> request.method.lower() <span class="keyword">in</span> self.http_method_names:</span><br><span class="line">                handler = getattr(self, request.method.lower(),</span><br><span class="line">                                  self.http_method_not_allowed)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                handler = self.http_method_not_allowed</span><br><span class="line"></span><br><span class="line">            response = handler(request, *args, **kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> exc:</span><br><span class="line">            response = self.handle_exception(exc)</span><br><span class="line"></span><br><span class="line">        self.response = self.finalize_response(request, response, *args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> self.response</span><br></pre></td></tr></table></figure>
<p>③initialize_request(重新封装了request对象)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initialize_request</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Returns the initial request object.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        parser_context = self.get_parser_context(request)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Request(</span><br><span class="line">            request,</span><br><span class="line">            parsers=self.get_parsers(),</span><br><span class="line">            authenticators=self.get_authenticators(),</span><br><span class="line">            negotiator=self.get_content_negotiator(),</span><br><span class="line">            parser_context=parser_context</span><br><span class="line">        )</span><br></pre></td></tr></table></figure>
<p>④initial方法（内部调用认证，权限和频率） </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">initial</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="string">"""</span></span><br><span class="line"><span class="string">        Runs anything that needs to occur prior to calling the method handler.</span></span><br><span class="line"><span class="string">        """</span></span><br><span class="line">        self.format_kwarg = self.get_format_suffix(**kwargs)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Perform content negotiation and store the accepted info on the request</span></span><br><span class="line">        neg = self.perform_content_negotiation(request)</span><br><span class="line">        request.accepted_renderer, request.accepted_media_type = neg</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Determine the API version, if versioning is in use.</span></span><br><span class="line">        version, scheme = self.determine_version(request, *args, **kwargs)</span><br><span class="line">        request.version, request.versioning_scheme = version, scheme</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Ensure that the incoming request is permitted</span></span><br><span class="line">        self.perform_authentication(request)</span><br><span class="line">        self.check_permissions(request)</span><br><span class="line">        self.check_throttles(request)</span><br><span class="line"></span><br><span class="line">initial方法（内部调用认证，权限和频率）</span><br></pre></td></tr></table></figure>
<h2 id="3-序列化组件"><a href="#3-序列化组件" class="headerlink" title="3.序列化组件"></a>3.序列化组件</h2><ul>
<li>Django 自带序列化组件</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    book_list = Book.objects.all()    </span><br><span class="line">    ret = serializers.serialize(<span class="string">"json"</span>, book_list)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(ret)</span><br></pre></td></tr></table></figure>
<ul>
<li>rest-framework序列化之Serializer</li>
</ul>
<p>① models.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Book</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    title=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    price=models.IntegerField()</span><br><span class="line">    pub_date=models.DateField()</span><br><span class="line">    publish=models.ForeignKey(<span class="string">"Publish"</span>)</span><br><span class="line">    authors=models.ManyToManyField(<span class="string">"Author"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.title</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Publish</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    email=models.EmailField()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Author</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    name=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    age=models.IntegerField()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.name</span><br></pre></td></tr></table></figure>
<p>②views.py</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> app01.models <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">from</span> django.core <span class="keyword">import</span> serializers</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> serializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializers</span><span class="params">(serializers.Serializer)</span>:</span></span><br><span class="line">    title=serializers.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    price=serializers.IntegerField()</span><br><span class="line">    pub_date=serializers.DateField()</span><br><span class="line">    publish=serializers.CharField(source=<span class="string">"publish.name"</span>)</span><br><span class="line">    <span class="comment">#authors=serializers.CharField(source="authors.all")</span></span><br><span class="line">    authors=serializers.SerializerMethodField()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_authors</span><span class="params">(self,obj)</span>:</span></span><br><span class="line">        temp=[]</span><br><span class="line">        <span class="keyword">for</span> author <span class="keyword">in</span> obj.authors.all():</span><br><span class="line">            temp.append(author.name)</span><br><span class="line">        <span class="keyword">return</span> temp</span><br><span class="line">　　<span class="comment">#此处可以继续用author的Serializers，</span></span><br><span class="line">　　<span class="comment"># def get_authors(self,obj):</span></span><br><span class="line">　　　　<span class="comment">#     ret=obj.authors.all()</span></span><br><span class="line">　　　　<span class="comment">#     ss=AuthorSerializer(ret,many=True)</span></span><br><span class="line">　　　　<span class="comment">#     return ss.data</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookViewSet</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        book_list=Book.objects.all()</span><br><span class="line">        <span class="comment"># 序列化方式1:</span></span><br><span class="line">        <span class="comment"># from django.forms.models import model_to_dict</span></span><br><span class="line">        <span class="comment"># import json</span></span><br><span class="line">        <span class="comment"># data=[]</span></span><br><span class="line">        <span class="comment"># for obj in book_list:</span></span><br><span class="line">        <span class="comment">#     data.append(model_to_dict(obj))</span></span><br><span class="line">        <span class="comment"># print(data)</span></span><br><span class="line">        <span class="comment"># return HttpResponse("ok")</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 序列化方式2:</span></span><br><span class="line">        <span class="comment"># data=serializers.serialize("json",book_list)</span></span><br><span class="line">        <span class="comment"># return HttpResponse(data)</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 序列化方式3:</span></span><br><span class="line">        bs=BookSerializers(book_list,many=<span class="keyword">True</span>)     <span class="comment">#many=True代表有多条数据，如果只有一条数据，many=False</span></span><br><span class="line">        <span class="keyword">return</span> Response(bs.data)</span><br><span class="line">　　　　 <span class="comment"># 序列化方式4: </span></span><br><span class="line">　　    <span class="comment"># ret=models.Book.objects.all().values('nid','title')</span></span><br><span class="line">　　　　 <span class="comment"># dd=list(ret)</span></span><br><span class="line">        <span class="comment"># return HttpResponse(json.dumps(dd))</span></span><br></pre></td></tr></table></figure>
<h3 id="source"><a href="#source" class="headerlink" title="source"></a>source</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">source 如果是字段，会显示字段，如果是方法，会执行方法，不用加括号（authors=serializers.CharField(source=<span class="string">'authors.all'</span>)）</span><br><span class="line"></span><br><span class="line">如在模型中定义一个方法，直接可以在在source指定执行</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserInfo</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    user_type_choices = (</span><br><span class="line">        (<span class="number">1</span>,<span class="string">'普通用户'</span>),</span><br><span class="line">        (<span class="number">2</span>,<span class="string">'VIP'</span>),</span><br><span class="line">        (<span class="number">3</span>,<span class="string">'SVIP'</span>),</span><br><span class="line">    )</span><br><span class="line">    user_type = models.IntegerField(choices=user_type_choices)</span><br><span class="line"></span><br><span class="line">    username = models.CharField(max_length=<span class="number">32</span>,unique=<span class="keyword">True</span>)</span><br><span class="line">    password = models.CharField(max_length=<span class="number">64</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#视图</span></span><br><span class="line">ret=models.UserInfo.objects.filter(pk=<span class="number">1</span>).first()</span><br><span class="line">aa=ret.get_user_type_display()</span><br><span class="line"></span><br><span class="line"><span class="comment">#serializer</span></span><br><span class="line">xx=serializers.CharField(source=<span class="string">'get_user_type_display'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>rest-framework序列化之ModelSerializer</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model = models.Book</span><br><span class="line">        <span class="comment"># fields = "__all__"</span></span><br><span class="line">        fields=[<span class="string">'nid'</span>,<span class="string">'title'</span>,<span class="string">'authors'</span>,<span class="string">'publish'</span>]</span><br><span class="line">        <span class="comment"># exclude=('nid',)   #不能跟fields同时用</span></span><br><span class="line">        <span class="comment"># depth = 1    #深度控制，层数越多，响应越慢</span></span><br><span class="line">    publish=serializers.SerializerMethodField()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_publish</span><span class="params">(self,obj)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> obj.publish.name</span><br><span class="line">    authors=serializers.SerializerMethodField()</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_authors</span><span class="params">(self,obj)</span>:</span></span><br><span class="line">        ret=obj.authors.all()</span><br><span class="line">        ss=AuthorSerializer(ret,many=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">return</span> ss.data</span><br></pre></td></tr></table></figure>
<ul>
<li>序列化组件之请求数据校验和保存功能</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model=Book</span><br><span class="line">        fields=<span class="string">"__all__"</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BookView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 添加一条数据</span></span><br><span class="line">        print(request.data)</span><br><span class="line">        bs=BookSerializers(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> bs.is_valid():</span><br><span class="line">            bs.save()  <span class="comment"># 生成记录</span></span><br><span class="line">            <span class="keyword">return</span> Response(bs.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(bs.errors)</span><br></pre></td></tr></table></figure>
<ul>
<li>序列化组件源码分析</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">序列化组件，先调用__new__方法，如果many=True，生成ListSerializer对象，如果为False，生成Serializer对象</span><br><span class="line">序列化对象.data方法--调用父类data方法---调用对象自己的to_representation（自定义的序列化类无此方法，去父类找）</span><br><span class="line">Aerializer类里有to_representation方法，for循环执行attribute = field.get_attribute(instance)</span><br><span class="line">再去Field类里去找get_attribute方法，self.source_attrs就是被切分的source，然后执行get_attribute方法，source_attrs</span><br><span class="line">当参数传过去，判断是方法就加括号执行，是属性就把值取出来</span><br></pre></td></tr></table></figure>
<h2 id="4-视图组件"><a href="#4-视图组件" class="headerlink" title="4.视图组件"></a>4.视图组件</h2><ul>
<li>基本视图</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns=[</span><br><span class="line">    url(<span class="string">r'^publish/$'</span>, views.PublishView.as_view()),</span><br><span class="line">    url(<span class="string">r'^publish/(?P&lt;pk&gt;\d+)/$'</span>, views.PublishDetailView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishSerializers</span><span class="params">(serializers.ModelSerializer)</span>:</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        model=models.Publish</span><br><span class="line">        fields=<span class="string">'__all__'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(APIView)</span>:</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        publish_list = models.Publish.objects.all()</span><br><span class="line">        bs = PublishSerializers(publish_list, many=<span class="keyword">True</span>)</span><br><span class="line">        <span class="comment"># 序列化数据</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(bs.data)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="comment"># 添加一条数据</span></span><br><span class="line">        print(request.data)</span><br><span class="line"></span><br><span class="line">        bs=PublishSerializers(data=request.data)</span><br><span class="line">        <span class="keyword">if</span> bs.is_valid():</span><br><span class="line">            bs.save()  <span class="comment"># 生成记录</span></span><br><span class="line">            <span class="keyword">return</span> Response(bs.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> Response(bs.errors)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishDetailView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,pk)</span>:</span></span><br><span class="line">        publish_obj=models.Publish.objects.filter(pk=pk).first()</span><br><span class="line">        bs=PublishSerializers(publish_obj,many=<span class="keyword">False</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(bs.data)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,request,pk)</span>:</span></span><br><span class="line">        publish_obj = models.Publish.objects.filter(pk=pk).first()</span><br><span class="line"></span><br><span class="line">        bs=PublishSerializers(data=request.data,instance=publish_obj)</span><br><span class="line">        <span class="keyword">if</span> bs.is_valid():</span><br><span class="line">            bs.save() <span class="comment"># update</span></span><br><span class="line">            <span class="keyword">return</span> Response(bs.data)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> Response(bs.errors)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,request,pk)</span>:</span></span><br><span class="line">        models.Publish.objects.filter(pk=pk).delete()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">""</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>mixin类和 generice类编写视图</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.mixins <span class="keyword">import</span> CreateModelMixin,RetrieveModelMixin,ListModelMixin,UpdateModelMixin,DestroyModelMixin</span><br><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> GenericAPIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(ListModelMixin,CreateModelMixin,GenericAPIView)</span>:</span></span><br><span class="line">    queryset=models.Publish.objects.all()</span><br><span class="line">    serializer_class=PublishSerializers</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.list(request)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.create(request)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishDetailView</span><span class="params">(RetrieveModelMixin,UpdateModelMixin,DestroyModelMixin,GenericAPIView)</span>:</span></span><br><span class="line">    queryset=models.Publish.objects.all()</span><br><span class="line">    serializer_class=PublishSerializers</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># retrieve()创建并保存</span></span><br><span class="line">        <span class="keyword">return</span> self.retrieve(request,*args,**kwargs)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.update(request,*args,**kwargs)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.destroy(request,*args,**kwargs)</span><br></pre></td></tr></table></figure>
<ul>
<li>generices 下的ListCreateAPIView，RetieveUpdateDestroyAPIView</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.generics <span class="keyword">import</span> ListCreateAPIView,RetrieveUpdateDestroyAPIView</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(ListCreateAPIView)</span>:</span></span><br><span class="line">    queryset=models.Publish.objects.all()</span><br><span class="line">    serializer_class=PublishSerializers</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishDetailView</span><span class="params">(RetrieveUpdateDestroyAPIView)</span>:</span></span><br><span class="line">    queryset=models.Publish.objects.all()</span><br><span class="line">    serializer_class=PublishSerializers</span><br></pre></td></tr></table></figure>
<ul>
<li>ModelViewSet</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns=[</span><br><span class="line">    url(<span class="string">r'^publish/$'</span>, views.PublishView.as_view(&#123;<span class="string">'get'</span>:<span class="string">'list'</span>,<span class="string">'post'</span>:<span class="string">'create'</span>&#125;)),</span><br><span class="line">    url(<span class="string">r'^publish/(?P&lt;pk&gt;\d+)/$'</span>, views.PublishView.as_view(&#123;<span class="string">'get'</span>:<span class="string">'retrieve'</span>,<span class="string">'put'</span>:<span class="string">'update'</span>,<span class="string">'delete'</span>:<span class="string">'destroy'</span>&#125;)),</span><br><span class="line">视图：</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset=models.Publish.objects.all()</span><br><span class="line">    serializer_class=PublishSerializers</span><br></pre></td></tr></table></figure>
<h2 id="5-解析器、认证组件、频率组件、权限组件"><a href="#5-解析器、认证组件、频率组件、权限组件" class="headerlink" title="5.解析器、认证组件、频率组件、权限组件"></a>5.解析器、认证组件、频率组件、权限组件</h2><h3 id="5-1-解析器"><a href="#5-1-解析器" class="headerlink" title="5.1 解析器"></a>5.1 解析器</h3><ul>
<li>作用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">根据请求头 content-type 选择对应的解析器对请求体内容进行处理。</span><br><span class="line">有application/json，x-www-form-urlencoded，form-data等格式</span><br></pre></td></tr></table></figure>
<ul>
<li>使用解析器</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">全局使用在settings.py中配置</span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 解析器</span></span><br><span class="line">    <span class="string">'DEFAULT_PARSER_CLASSES'</span>:[</span><br><span class="line">        <span class="string">'rest_framework.parsers.JSONParser'</span></span><br><span class="line">        <span class="string">'rest_framework.parsers.FormParser'</span></span><br><span class="line">        <span class="string">'rest_framework.parsers.MultiPartParser'</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="comment"># 全局使用认证组件</span></span><br><span class="line">    <span class="string">"DEFAULT_AUTHENTICATION_CLASSES"</span>:[<span class="string">"app01.service.auth.Authentication"</span>,],</span><br><span class="line">    <span class="comment"># 全局使用权限组件</span></span><br><span class="line">    <span class="string">"DEFAULT_AUTHENTICATION_CLASSES"</span>:[<span class="string">"app01.service.auth.Authentication"</span>,],</span><br><span class="line">    <span class="string">"DEFAULT_PERMISSION_CLASSES"</span>:[<span class="string">"app01.service.permissions.SVIPPermission"</span>,]</span><br><span class="line">    <span class="comment"># 全局使用频率组件,1min访问3次</span></span><br><span class="line">    <span class="string">'DEFAULT_THROTTLE_RATES'</span>:&#123;</span><br><span class="line">        <span class="string">'luffy'</span>:<span class="string">'3/m'</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">urls.py</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'test/'</span>, TestView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">views.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.views <span class="keyword">import</span> APIView</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework.request <span class="keyword">import</span> Request</span><br><span class="line"><span class="keyword">from</span> rest_framework.parsers <span class="keyword">import</span> JSONParser,FormParser,MultiPartParser</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TestView</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="comment"># 局部解析器,为MultiPartParser时,前端的form表单中必须有enctype="multipart/form-data"</span></span><br><span class="line">    parser_classes = [JSONParser,FormParser,MultiPartParser ]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        print(request.content_type)</span><br><span class="line"></span><br><span class="line">        <span class="comment"># 获取请求的值，并使用对应的JSONParser进行处理</span></span><br><span class="line">        print(request.data)</span><br><span class="line">        <span class="comment"># application/x-www-form-urlencoded 或 multipart/form-data时，request.POST中才有值</span></span><br><span class="line">        print(request.POST)</span><br><span class="line">        print(request.FILES)</span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'POST请求，响应内容'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">put</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> Response(<span class="string">'PUT请求，响应内容'</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>源码分析</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">在调用request.data时，才进行解析，由此入手</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">data</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> _hasattr(self, <span class="string">'_full_data'</span>):</span><br><span class="line">            self._load_data_and_files()</span><br><span class="line">        <span class="keyword">return</span> self._full_data</span><br><span class="line">查看self._load_data_and_files()方法----&gt;self._data, self._files = self._parse()</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_parse</span><span class="params">(self)</span>:</span></span><br><span class="line">            <span class="comment">#用户请求头里content_type的值</span></span><br><span class="line">            media_type = self.content_type</span><br><span class="line"></span><br><span class="line">            <span class="comment">#self.parsers 就是用户配置的parser_classes = [FileUploadParser,FormParser ]</span></span><br><span class="line">            <span class="comment">#self里就有content_type，传入此函数</span></span><br><span class="line">            parser = self.negotiator.select_parser(self, self.parsers)</span><br><span class="line">查看self.negotiator.select_parser(self, self.parsers)</span><br><span class="line">     <span class="function"><span class="keyword">def</span> <span class="title">select_parser</span><span class="params">(self, request, parsers)</span>:</span></span><br><span class="line">        <span class="comment">#同过media_type和request.content_type比较，来返回解析器，然后调用解析器的解析方法</span></span><br><span class="line">        <span class="comment">#每个解析器都有media_type = 'multipart/form-data'属性</span></span><br><span class="line">        <span class="keyword">for</span> parser <span class="keyword">in</span> parsers:</span><br><span class="line">            <span class="keyword">if</span> media_type_matches(parser.media_type, request.content_type):</span><br><span class="line">                <span class="keyword">return</span> parser</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">None</span></span><br><span class="line">最终调用parser的解析方法来解析parsed = parser.parse(stream, media_type, self.parser_context)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">Request实例化，parsers=self.get_parsers()</span><br><span class="line">    Request(</span><br><span class="line">                request,</span><br><span class="line">                parsers=self.get_parsers(),</span><br><span class="line">                authenticators=self.get_authenticators(),</span><br><span class="line">                negotiator=self.get_content_negotiator(),</span><br><span class="line">                parser_context=parser_context</span><br><span class="line">            )</span><br><span class="line">get_parsers方法，循环实例化出self.parser_classes中类对象</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_parsers</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> [parser() <span class="keyword">for</span> parser <span class="keyword">in</span> self.parser_classes]            </span><br><span class="line">self.parser_classes 先从类本身找，找不到去父类找即APIVIew 中的</span><br><span class="line">    parser_classes = api_settings.DEFAULT_PARSER_CLASSES</span><br><span class="line">api_settings是一个对象，对象里找DEFAULT_PARSER_CLASSES属性，找不到，会到getattr方法</span><br><span class="line">        <span class="function"><span class="keyword">def</span> <span class="title">__getattr__</span><span class="params">(self, attr)</span>:</span></span><br><span class="line">            <span class="keyword">if</span> attr <span class="keyword">not</span> <span class="keyword">in</span> self.defaults:</span><br><span class="line">                <span class="keyword">raise</span> AttributeError(<span class="string">"Invalid API setting: '%s'"</span> % attr)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                <span class="comment">#调用self.user_settings方法，返回一个字典，字典再取attr属性</span></span><br><span class="line">                val = self.user_settings[attr]</span><br><span class="line">            <span class="keyword">except</span> KeyError:</span><br><span class="line">                <span class="comment"># Fall back to defaults</span></span><br><span class="line">                val = self.defaults[attr]</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Coerce import strings into classes</span></span><br><span class="line">            <span class="keyword">if</span> attr <span class="keyword">in</span> self.import_strings:</span><br><span class="line">                val = perform_import(val, attr)</span><br><span class="line"></span><br><span class="line">            <span class="comment"># Cache the result</span></span><br><span class="line">            self._cached_attrs.add(attr)</span><br><span class="line">            setattr(self, attr, val)</span><br><span class="line">            <span class="keyword">return</span> val</span><br><span class="line">user_settings方法 ，通过反射去setting配置文件里找REST_FRAMEWORK属性，找不到，返回空字典</span><br><span class="line"><span class="meta">    @property</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">user_settings</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_user_settings'</span>):</span><br><span class="line">            self._user_settings = getattr(settings, <span class="string">'REST_FRAMEWORK'</span>, &#123;&#125;)</span><br><span class="line">        <span class="keyword">return</span> self._user_settings</span><br></pre></td></tr></table></figure>
<h3 id="5-2-认证组件"><a href="#5-2-认证组件" class="headerlink" title="5.2 认证组件"></a>5.2 认证组件</h3><ul>
<li>models.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">User</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    username=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    password=models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    user_type=models.IntegerField(choices=((<span class="number">1</span>,<span class="string">'超级用户'</span>),(<span class="number">2</span>,<span class="string">'普通用户'</span>),(<span class="number">3</span>,<span class="string">'二笔用户'</span>)))</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserToken</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    user=models.OneToOneField(to=<span class="string">'User'</span>)</span><br><span class="line">    token=models.CharField(max_length=<span class="number">64</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>新建认证类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authentication <span class="keyword">import</span> BaseAuthentication</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TokenAuth</span><span class="params">()</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        token = request.GET.get(<span class="string">'token'</span>)</span><br><span class="line">        token_obj = models.UserToken.objects.filter(token=token).first()</span><br><span class="line">        <span class="keyword">if</span> token_obj:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">raise</span> AuthenticationFailed(<span class="string">'认证失败'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">authenticate_header</span><span class="params">(self,request)</span>:</span></span><br><span class="line">        <span class="keyword">pass</span></span><br></pre></td></tr></table></figure>
<ul>
<li>views.py</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_random</span><span class="params">(name)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> hashlib</span><br><span class="line">    <span class="keyword">import</span> time</span><br><span class="line">    md=hashlib.md5()</span><br><span class="line">    md.update(bytes(str(time.time()),encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">    md.update(bytes(name,encoding=<span class="string">'utf-8'</span>))</span><br><span class="line">    <span class="keyword">return</span> md.hexdigest()</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Login</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self,reuquest)</span>:</span></span><br><span class="line">        back_msg=&#123;<span class="string">'status'</span>:<span class="number">1001</span>,<span class="string">'msg'</span>:<span class="keyword">None</span>&#125;</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            name=reuquest.data.get(<span class="string">'name'</span>)</span><br><span class="line">            pwd=reuquest.data.get(<span class="string">'pwd'</span>)</span><br><span class="line">            user=models.User.objects.filter(username=name,password=pwd).first()</span><br><span class="line">            <span class="keyword">if</span> user:</span><br><span class="line">                token=get_random(name)</span><br><span class="line">                models.UserToken.objects.update_or_create(user=user,defaults=&#123;<span class="string">'token'</span>:token&#125;)</span><br><span class="line">                back_msg[<span class="string">'status'</span>]=<span class="string">'1000'</span></span><br><span class="line">                back_msg[<span class="string">'msg'</span>]=<span class="string">'登录成功'</span></span><br><span class="line">                back_msg[<span class="string">'token'</span>]=token</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                back_msg[<span class="string">'msg'</span>] = <span class="string">'用户名或密码错误'</span></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            back_msg[<span class="string">'msg'</span>]=str(e)</span><br><span class="line">        <span class="keyword">return</span> Response(back_msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="comment"># 局部使用</span></span><br><span class="line">    authentication_classes = [TokenAuth, ]</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'get'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'post'</span>)</span><br></pre></td></tr></table></figure>
<h4 id="token认证：存数据库的—-gt-Redis—-gt-不存数据库的认证"><a href="#token认证：存数据库的—-gt-Redis—-gt-不存数据库的认证" class="headerlink" title="token认证：存数据库的—&gt;Redis—&gt;不存数据库的认证"></a>token认证：存数据库的—&gt;Redis—&gt;不存数据库的认证</h4><h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Request对象的user方法</span></span><br><span class="line"><span class="meta">@property</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">user</span><span class="params">(self)</span>:</span></span><br><span class="line"><span class="comment"># the authentication classes provided to the request.</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(self, <span class="string">'_user'</span>):</span><br><span class="line">            <span class="keyword">with</span> wrap_attributeerrors():</span><br><span class="line">                self._authenticate()</span><br><span class="line">        <span class="keyword">return</span> self._user</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_authenticate</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">for</span> authenticator <span class="keyword">in</span> self.authenticators:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                user_auth_tuple = authenticator.authenticate(self)</span><br><span class="line">            <span class="keyword">except</span> exceptions.APIException:</span><br><span class="line">                self._not_authenticated()</span><br><span class="line">                <span class="keyword">raise</span></span><br><span class="line">            <span class="comment">#认证成功，可以返回一个元组，但必须是最后一个验证类才能返回</span></span><br><span class="line">            <span class="keyword">if</span> user_auth_tuple <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</span><br><span class="line">                self._authenticator = authenticator</span><br><span class="line">                self.user, self.auth = user_auth_tuple</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        self._not_authenticated()</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="comment"># self.authenticators</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_authenticators</span><span class="params">(self)</span>:</span></span><br><span class="line">	<span class="keyword">return</span> [auth() <span class="keyword">for</span> auth <span class="keyword">in</span> self.authentication_classes]</span><br><span class="line"></span><br><span class="line">认证类使用顺序：先用视图类中的验证类，再用settings里配置的验证类，最后用默认的验证类</span><br></pre></td></tr></table></figure>
<h3 id="6-2-频率组件"><a href="#6-2-频率组件" class="headerlink" title="6.2 频率组件"></a>6.2 频率组件</h3><ul>
<li>局部使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">permission_classes = [UserPermission,]</span><br></pre></td></tr></table></figure>
<h4 id="源码分析-1"><a href="#源码分析-1" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">check_permissions</span><span class="params">(self, request)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> permission <span class="keyword">in</span> self.get_permissions():</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> permission.has_permission(request, self):</span><br><span class="line">            self.permission_denied(</span><br><span class="line">                request, message=getattr(permission, <span class="string">'message'</span>, <span class="keyword">None</span>)</span><br><span class="line">                )</span><br><span class="line">            </span><br><span class="line"><span class="comment"># self.get_permissions()</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_permissions</span><span class="params">(self)</span>:</span></span><br><span class="line">     <span class="keyword">return</span> [permission() <span class="keyword">for</span> permission <span class="keyword">in</span> self.permission_classes]</span><br></pre></td></tr></table></figure>
<h3 id="6-3-权限组件"><a href="#6-3-权限组件" class="headerlink" title="6.3 权限组件"></a>6.3 权限组件</h3><ul>
<li>自定义限制 ip 的访问频率</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#（1）取出访问者ip</span></span><br><span class="line"><span class="comment"># （2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问，在字典里，继续往下走</span></span><br><span class="line"><span class="comment"># （3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，</span></span><br><span class="line"><span class="comment"># （4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过</span></span><br><span class="line"><span class="comment"># （5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThrottles</span><span class="params">()</span>:</span></span><br><span class="line">    VISIT_RECORD = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self.history=<span class="keyword">None</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">allow_request</span><span class="params">(self,request, view)</span>:</span></span><br><span class="line">        <span class="comment">#（1）取出访问者ip</span></span><br><span class="line">        <span class="comment"># print(request.META)</span></span><br><span class="line">        ip=request.META.get(<span class="string">'REMOTE_ADDR'</span>)</span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        ctime=time.time()</span><br><span class="line">        <span class="comment"># （2）判断当前ip不在访问字典里，添加进去，并且直接返回True,表示第一次访问</span></span><br><span class="line">        <span class="keyword">if</span> ip <span class="keyword">not</span> <span class="keyword">in</span> self.VISIT_RECORD:</span><br><span class="line">            self.VISIT_RECORD[ip]=[ctime,]</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        self.history=self.VISIT_RECORD.get(ip)</span><br><span class="line">        <span class="comment"># （3）循环判断当前ip的列表，有值，并且当前时间减去列表的最后一个时间大于60s，把这种数据pop掉，这样列表中只有60s以内的访问时间，</span></span><br><span class="line">        <span class="keyword">while</span> self.history <span class="keyword">and</span> ctime-self.history[<span class="number">-1</span>]&gt;<span class="number">60</span>:</span><br><span class="line">            self.history.pop()</span><br><span class="line">        <span class="comment"># （4）判断，当列表小于3，说明一分钟以内访问不足三次，把当前时间插入到列表第一个位置，返回True，顺利通过</span></span><br><span class="line">        <span class="comment"># （5）当大于等于3，说明一分钟内访问超过三次，返回False验证失败</span></span><br><span class="line">        <span class="keyword">if</span> len(self.history)&lt;<span class="number">3</span>:</span><br><span class="line">            self.history.insert(<span class="number">0</span>,ctime)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">import</span> time</span><br><span class="line">        ctime=time.time()</span><br><span class="line">        <span class="keyword">return</span> <span class="number">60</span>-(ctime-self.history[<span class="number">-1</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li>局部使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">throttle_classes = [MyThrottles,]</span><br></pre></td></tr></table></figure>
<ul>
<li>错误信息的中文提示</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Course</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    authentication_classes = [TokenAuth, ]</span><br><span class="line">    permission_classes = [UserPermission, ]</span><br><span class="line">    throttle_classes = [MyThrottles,]</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'get'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">post</span><span class="params">(self, request)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> HttpResponse(<span class="string">'post'</span>)</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">throttled</span><span class="params">(self, request, wait)</span>:</span></span><br><span class="line">        <span class="keyword">from</span> rest_framework.exceptions <span class="keyword">import</span> Throttled</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">MyThrottled</span><span class="params">(Throttled)</span>:</span></span><br><span class="line">            default_detail = <span class="string">'傻逼啊'</span></span><br><span class="line">            extra_detail_singular = <span class="string">'还有 &#123;wait&#125; second.'</span></span><br><span class="line">            extra_detail_plural = <span class="string">'出了 &#123;wait&#125; seconds.'</span></span><br><span class="line">        <span class="keyword">raise</span> MyThrottled(wait)</span><br></pre></td></tr></table></figure>
<h2 id="7-分页器"><a href="#7-分页器" class="headerlink" title="7.分页器"></a>7.分页器</h2><ul>
<li>简单分页</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> PageNumberPagination</span><br><span class="line"><span class="comment"># 一 基本使用：url=url=http://127.0.0.1:8000/pager/?page=2&amp;size=3，size无效</span></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">Pager</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        ret=models.Book.objects.all()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        page=PageNumberPagination()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据</span></span><br><span class="line">        page_list=page.paginate_queryset(ret,request,view=self)</span><br><span class="line">        <span class="comment"># 对分页进行序列化</span></span><br><span class="line">        ser=BookSerializer1(instance=page_list,many=<span class="keyword">True</span>)</span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br><span class="line"><span class="comment"># 二 自定制 url=http://127.0.0.1:8000/pager/?page=2&amp;size=3</span></span><br><span class="line"><span class="comment"># size=30，无效，最多5条</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mypage</span><span class="params">(PageNumberPagination)</span>:</span></span><br><span class="line">    page_size = <span class="number">2</span></span><br><span class="line">    page_query_param = <span class="string">'page'</span></span><br><span class="line">    <span class="comment"># 定制传参</span></span><br><span class="line">    page_size_query_param = <span class="string">'size'</span></span><br><span class="line">    <span class="comment"># 最大一页的数据</span></span><br><span class="line">    max_page_size = <span class="number">5</span></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">Pager</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        ret=models.Book.objects.all()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        page=Mypage()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据</span></span><br><span class="line">        page_list=page.paginate_queryset(ret,request,view=self)</span><br><span class="line">        <span class="comment"># 对分页进行序列化</span></span><br><span class="line">        ser=BookSerializer1(instance=page_list,many=<span class="keyword">True</span>)</span><br><span class="line">        <span class="comment"># return Response(ser.data)</span></span><br><span class="line">        <span class="comment"># 这个也是返回Response对象，但是比基本的多了上一页，下一页，和总数据条数（了解即可）</span></span><br><span class="line">        <span class="keyword">return</span> page.get_paginated_response(ser.data)</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">settings.py</span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="comment"># 每页显示两条</span></span><br><span class="line">    <span class="string">'PAGE_SIZE'</span>:<span class="number">2</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns=[</span><br><span class="line">    url(<span class="string">r'^pager/$'</span>, views.Pager.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>偏移分页</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">在第N个位置,向后查看N条数据</span><br><span class="line"><span class="comment"># http://127.0.0.1:8000/pager/?offset=4&amp;limit=3</span></span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> LimitOffsetPagination</span><br><span class="line"><span class="comment"># 也可以自定制，同简单分页</span></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">Pager</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        ret=models.Book.objects.all()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        page=LimitOffsetPagination()</span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据</span></span><br><span class="line">        page_list=page.paginate_queryset(ret,request,view=self)</span><br><span class="line">        <span class="comment"># 对分页进行序列化</span></span><br><span class="line">        ser=BookSerializer1(instance=page_list,many=<span class="keyword">True</span>)</span><br><span class="line">        <span class="comment"># return page.get_paginated_response(ser.data)</span></span><br><span class="line">        <span class="keyword">return</span> Response(ser.data)</span><br></pre></td></tr></table></figure>
<ul>
<li>CursorPagination加密分页</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">只能查看上页和下页</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.pagination <span class="keyword">import</span> CursorPagination</span><br><span class="line"><span class="comment"># 看源码，是通过sql查询，大于id和小于id</span></span><br><span class="line"><span class="class"><span class="keyword">class</span>  <span class="title">Pager</span><span class="params">(APIView)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(self,request,*args,**kwargs)</span>:</span></span><br><span class="line">        <span class="comment"># 获取所有数据</span></span><br><span class="line">        ret=models.Book.objects.all()</span><br><span class="line">        <span class="comment"># 创建分页对象</span></span><br><span class="line">        page=CursorPagination()</span><br><span class="line">        page.ordering=<span class="string">'nid'</span></span><br><span class="line">        <span class="comment"># 在数据库中获取分页的数据</span></span><br><span class="line">        page_list=page.paginate_queryset(ret,request,view=self)</span><br><span class="line">        <span class="comment"># 对分页进行序列化</span></span><br><span class="line">        ser=BookSerializer1(instance=page_list,many=<span class="keyword">True</span>)</span><br><span class="line">        <span class="comment"># 可以避免页码被猜到</span></span><br><span class="line">        <span class="keyword">return</span> page.get_paginated_response(ser.data)</span><br></pre></td></tr></table></figure>
<h2 id="8-响应器（渲染器）"><a href="#8-响应器（渲染器）" class="headerlink" title="8.响应器（渲染器）"></a>8.响应器（渲染器）</h2><ul>
<li>作用</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">根据 用户请求URL 或 用户可接受的类型，筛选出合适的 渲染组件。</span><br></pre></td></tr></table></figure>
<ul>
<li>内置渲染器</li>
</ul>
<p>①<strong>默认显示格式：BrowsableAPIRenderer（可以修改它的html文件）</strong></p>
<ul>
<li><a href="http://127.0.0.1:8000/test/?format=api" target="_blank" rel="noopener">http://127.0.0.1:8000/test/?format=api</a></li>
<li><a href="http://127.0.0.1:8000/test.api" target="_blank" rel="noopener">http://127.0.0.1:8000/test.api</a> </li>
</ul>
<p>②<strong>显示json格式：JSONRenderer</strong> </p>
<ul>
<li><a href="http://127.0.0.1:8000/test/?format=json" target="_blank" rel="noopener">http://127.0.0.1:8000/test/?format=json</a></li>
<li><a href="http://127.0.0.1:8000/test.json" target="_blank" rel="noopener">http://127.0.0.1:8000/test.json</a></li>
</ul>
<p>③<strong>表格方式：AdminRenderer</strong> </p>
<ul>
<li><a href="http://127.0.0.1:8000/test/?format=admin" target="_blank" rel="noopener">http://127.0.0.1:8000/test/?format=admin</a></li>
<li><a href="http://127.0.0.1:8000/test.admin" target="_blank" rel="noopener">http://127.0.0.1:8000/test.admin</a></li>
</ul>
<p>④<strong>form表单方式：HTMLFormRenderer</strong> </p>
<ul>
<li><a href="http://127.0.0.1:8000/test/?format=form" target="_blank" rel="noopener">http://127.0.0.1:8000/test/?format=form</a></li>
<li><a href="http://127.0.0.1:8000/test.form" target="_blank" rel="noopener">http://127.0.0.1:8000/test.form</a></li>
</ul>
<ul>
<li>局部使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">renderer_classes = [HTMLFormRenderer,BrowsableAPIRenderer ]</span><br></pre></td></tr></table></figure>
<h2 id="9-URL控制器"><a href="#9-URL控制器" class="headerlink" title="9.URL控制器"></a>9.URL控制器</h2><ul>
<li>自定义路由（原始方式）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^books/$'</span>, views.BookView.as_view()),</span><br><span class="line">    url(<span class="string">r'^books/(?P&lt;pk&gt;\d+)$'</span>, views.BookDetailView.as_view()),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>半自动路由（视图继承ModelViewSet）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">urls.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^publish/$'</span>, views.PublishView.as_view(&#123;<span class="string">'get'</span>:<span class="string">'list'</span>,<span class="string">'post'</span>:<span class="string">'create'</span>&#125;)),</span><br><span class="line">    url(<span class="string">r'^publish/(?P&lt;pk&gt;\d+)/$'</span>, views.PublishView.as_view(&#123;<span class="string">'get'</span>:<span class="string">'retrieve'</span>,<span class="string">'put'</span>:<span class="string">'update'</span>,<span class="string">'delete'</span>:<span class="string">'destroy'</span>&#125;)),</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">views.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset=models.Publish.objects.all()</span><br><span class="line">    serializer_class=PublishSerializers</span><br></pre></td></tr></table></figure>
<ul>
<li>全自动路由（自动生成路由）</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">urls.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url,include</span><br><span class="line"><span class="keyword">from</span> app01 <span class="keyword">import</span> views</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> routers</span><br><span class="line">router=routers.DefaultRouter()</span><br><span class="line"><span class="comment"># 两个参数，一个是匹配的路由，一个是视图中写的CBV的类</span></span><br><span class="line">router.register(<span class="string">'publish'</span>,views.PublishView)</span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># http://127.0.0.1:8000/publish/format=json(渲染器通过这个判断，返回渲染的页面)</span></span><br><span class="line">    <span class="comment"># url(r'^publish/', views.PublishView.as_view(&#123;'get':'list','post':'create'&#125;)),</span></span><br><span class="line">    <span class="comment"># http://127.0.0.1:8000/publish.json(渲染器通过这个判断，返回渲染的页面)</span></span><br><span class="line">    <span class="comment"># url(r'^publish\.(?P&lt;format&gt;\w+)$', views.PublishView.as_view(&#123;'get':'list','post':'create'&#125;)),</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 可以用 以下方式访问</span></span><br><span class="line">    <span class="comment"># 1 http://127.0.0.1:8000/publish/</span></span><br><span class="line">    <span class="comment"># 2 http://127.0.0.1:8000/publish.json</span></span><br><span class="line">    <span class="comment"># 3 http://127.0.0.1:8000/publish/3</span></span><br><span class="line">    <span class="comment"># 4 http://127.0.0.1:8000/publish/3.json   </span></span><br><span class="line">    url(<span class="string">r''</span>,include(router.urls))</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">views.py</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.viewsets <span class="keyword">import</span> ModelViewSet</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PublishView</span><span class="params">(ModelViewSet)</span>:</span></span><br><span class="line">    queryset=models.Publish.objects.all()</span><br><span class="line">    serializer_class=PublishSerializers</span><br></pre></td></tr></table></figure>
<h2 id="10-版本控制"><a href="#10-版本控制" class="headerlink" title="10.版本控制"></a>10.版本控制</h2><ul>
<li>内置的版本控制类</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.versioning <span class="keyword">import</span> QueryParameterVersioning,AcceptHeaderVersioning,NamespaceVersioning,URLPathVersioning</span><br><span class="line"></span><br><span class="line"><span class="comment">#基于url的get传参方式：QueryParameterVersioning------&gt;如：/users?version=v1</span></span><br><span class="line"><span class="comment">#基于url的正则方式：URLPathVersioning------&gt;/v1/users/</span></span><br><span class="line"><span class="comment">#基于 accept 请求头方式：AcceptHeaderVersioning------&gt;Accept: application/json; version=1.0</span></span><br><span class="line"><span class="comment">#基于主机名方法：HostNameVersioning------&gt;v1.example.com</span></span><br><span class="line"><span class="comment">#基于django路由系统的namespace：NamespaceVersioning------&gt;example.com/v1/users/</span></span><br></pre></td></tr></table></figure>
<ul>
<li>局部使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在CBV类中加入</span></span><br><span class="line">versioning_class = URLPathVersioning</span><br></pre></td></tr></table></figure>
<ul>
<li>全局使用</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK = &#123;</span><br><span class="line">    <span class="string">'DEFAULT_VERSIONING_CLASS'</span>:<span class="string">'rest_framework.versioning.QueryParameterVersioning'</span>,</span><br><span class="line">    <span class="string">'DEFAULT_VERSION'</span>: <span class="string">'v1'</span>,            <span class="comment"># 默认版本(从request对象里取不到，显示的默认值)</span></span><br><span class="line">    <span class="string">'ALLOWED_VERSIONS'</span>: [<span class="string">'v1'</span>, <span class="string">'v2'</span>],   <span class="comment"># 允许的版本</span></span><br><span class="line">    <span class="string">'VERSION_PARAM'</span>: <span class="string">'version'</span>          <span class="comment"># URL中获取值的key</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="源码分析-2"><a href="#源码分析-2" class="headerlink" title="源码分析"></a>源码分析</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行determine_version，返回两个值，放到request对象里</span></span><br><span class="line">version, scheme = self.determine_version(request, *args, **kwargs)</span><br><span class="line">request.version, request.versioning_scheme = version, scheme</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">determine_version</span><span class="params">(self, request, *args, **kwargs)</span>:</span></span><br><span class="line">        <span class="comment">#当配置上版本类之后，就会实例化</span></span><br><span class="line">        <span class="keyword">if</span> self.versioning_class <span class="keyword">is</span> <span class="keyword">None</span>:</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">None</span>, <span class="keyword">None</span>)</span><br><span class="line">        scheme = self.versioning_class()</span><br><span class="line">        <span class="keyword">return</span> (scheme.determine_version(request, *args, **kwargs), scheme)</span><br></pre></td></tr></table></figure>
<h1 id="八、settings-py配置"><a href="#八、settings-py配置" class="headerlink" title="八、settings.py配置"></a>八、settings.py配置</h1><h2 id="1-APPEND-SLASH"><a href="#1-APPEND-SLASH" class="headerlink" title="1.APPEND_SLASH"></a>1.<strong>APPEND_SLASH</strong></h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">APPEND_SLASH=<span class="keyword">True</span></span><br><span class="line">是否开启URL访问地址后面不为/跳转至带有/的路径的配置项</span><br></pre></td></tr></table></figure>
<h2 id="2-static（css文件，js文件，图片文件-）"><a href="#2-static（css文件，js文件，图片文件-）" class="headerlink" title="2.static（css文件，js文件，图片文件 ）"></a>2.static（css文件，js文件，图片文件 ）</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">STATIC_URL = <span class="string">'/static/'</span></span><br><span class="line">STATICFILES_DIRS = [</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">'static'</span>),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>html页面对static静态文件的使用</li>
</ul>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"stylesheet"</span> <span class="attr">href</span>=<span class="string">"/static/mycss.css"</span>&gt;</span> </span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"/static/jquery-3.3.1.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="3-数据库配置"><a href="#3-数据库配置" class="headerlink" title="3 数据库配置"></a>3 数据库配置</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'lqz'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'root'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'123456'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'127.0.0.1'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="number">3306</span>,</span><br><span class="line">        <span class="string">'ATOMIC_REQUEST'</span>: <span class="keyword">True</span>,</span><br><span class="line">        <span class="string">'OPTIONS'</span>: &#123;</span><br><span class="line">            <span class="string">"init_command"</span>: <span class="string">"SET storage_engine=MyISAM"</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="string">'''</span></span><br><span class="line"><span class="string">'NAME':要连接的数据库，连接前需要创建好</span></span><br><span class="line"><span class="string">'USER':连接数据库的用户名</span></span><br><span class="line"><span class="string">'PASSWORD':连接数据库的密码</span></span><br><span class="line"><span class="string">'HOST':连接主机，默认本机</span></span><br><span class="line"><span class="string">'PORT':端口 默认3306</span></span><br><span class="line"><span class="string">'ATOMIC_REQUEST': True,</span></span><br><span class="line"><span class="string">设置为True统一个http请求对应的所有sql都放在一个事务中执行（要么所有都成功，要么所有都失败）。</span></span><br><span class="line"><span class="string">是全局性的配置， 如果要对某个http请求放水（然后自定义事务），可以用non_atomic_requests修饰器 </span></span><br><span class="line"><span class="string">'OPTIONS': &#123;</span></span><br><span class="line"><span class="string">             "init_command": "SET storage_engine=MyISAM",</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">设置创建表的存储引擎为MyISAM，INNODB</span></span><br><span class="line"><span class="string">'''</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 注意1：</span></span><br><span class="line">	在mysql连接数据库前必须已经创建数据库，而上面的sqlite数据库下的db.sqlite3则是项目自动创建 USER和PASSWORD分别是数据库的用户名和密码。设置完后，再启动我们的Django项目前，我们需要激活我们的mysql。然后，启动项目，会报错：no module named MySQLdb 。这是因为django默认你导入的驱动是MySQLdb，可是MySQLdb 对于py3有很大问题，所以我们需要的驱动是PyMySQL 所以，我们只需要找到项目名文件下的__init__,在里面写入：</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br><span class="line"></span><br><span class="line">	通过两条数据库迁移命令即可在指定的数据库中创建表</span><br><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br><span class="line"></span><br><span class="line"><span class="comment"># 注意2:</span></span><br><span class="line">    确保配置文件中的INSTALLED_APPS中写入我们创建的app名称</span><br></pre></td></tr></table></figure>
<ul>
<li>打印orm转换过程中的sql</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">LOGGING = &#123;</span><br><span class="line">    <span class="string">'version'</span>: <span class="number">1</span>,</span><br><span class="line">    <span class="string">'disable_existing_loggers'</span>: <span class="keyword">False</span>,</span><br><span class="line">    <span class="string">'handlers'</span>: &#123;</span><br><span class="line">        <span class="string">'console'</span>:&#123;</span><br><span class="line">            <span class="string">'level'</span>:<span class="string">'DEBUG'</span>,</span><br><span class="line">            <span class="string">'class'</span>:<span class="string">'logging.StreamHandler'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">'loggers'</span>: &#123;</span><br><span class="line">        <span class="string">'django.db.backends'</span>: &#123;</span><br><span class="line">            <span class="string">'handlers'</span>: [<span class="string">'console'</span>],</span><br><span class="line">            <span class="string">'propagate'</span>: <span class="keyword">True</span>,</span><br><span class="line">            <span class="string">'level'</span>:<span class="string">'DEBUG'</span>,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">or</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 操作数据库时取出的对象obj</span></span><br><span class="line">print(obj.query)</span><br></pre></td></tr></table></figure>
<h1 id="九、创建Django"><a href="#九、创建Django" class="headerlink" title="九、创建Django"></a>九、创建Django</h1><p>0 <strong>安装Django</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django</span><br></pre></td></tr></table></figure>
<p>1 <strong>创建一个 Django project</strong> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">django-admin.py startproject mysite</span><br></pre></td></tr></table></figure>
<p>2 <strong>在mysite目录下创建应用</strong> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py startapp app01</span><br></pre></td></tr></table></figure>
<p>3 <strong>启动Django项目</strong> </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python manage.py runserver http://ip:<span class="number">8000</span></span><br></pre></td></tr></table></figure>
<h1 id="十、跨域请求（同源策略）"><a href="#十、跨域请求（同源策略）" class="headerlink" title="十、跨域请求（同源策略）"></a>十、跨域请求（同源策略）</h1><ul>
<li>定义</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">同源策略（Same origin policy）是一种约定，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，则浏览器的正常功能可能都会受到影响。可以说Web是构建在同源策略基础之上的，浏览器只是针对同源策略的一种实现</span><br><span class="line"></span><br><span class="line">同一个 http://ip:port(假设是 http://127.0.0.1:8000)</span><br><span class="line">当使用http://127.0.0.1:8001访问时，会抛出错误</span><br><span class="line">	已拦截跨源请求：同源策略禁止读取位于 http://127.0.0.1:8001/SendAjax/ 的远程资源。（原因：CORS 头缺少 &apos;Access-Control-Allow-Origin&apos;）。</span><br></pre></td></tr></table></figure>
<ul>
<li>跨域资源共享（CORS）基本流程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">浏览器将CORS请求分成两类：简单请求（simple request）和非简单请求（not-so-simple request）。</span><br><span class="line">浏览器发出CORS简单请求，只需要在头信息之中增加一个Origin字段。</span><br><span class="line">浏览器发出CORS非简单请求，会在正式通信之前，增加一次HTTP查询请求，称为&quot;预检&quot;请求（preflight）。浏览器先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用哪些HTTP动词和头信息字段。只有得到肯定答复，浏览器才会发出正式的XMLHttpRequest请求，否则就报错。</span><br></pre></td></tr></table></figure>
<ul>
<li>CORS简单请求</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">（1) 请求方法是以下三种方法之一：</span><br><span class="line">HEAD</span><br><span class="line">GET</span><br><span class="line">POST</span><br><span class="line">（2）HTTP的头信息不超出以下几种字段：</span><br><span class="line">Accept</span><br><span class="line">Accept-Language</span><br><span class="line">Content-Language</span><br><span class="line">Last-Event-ID</span><br><span class="line">Content-Type：只限于三个值application/x-www-form-urlencoded、multipart/form-data、text/plain</span><br></pre></td></tr></table></figure>
<ul>
<li>CORS非简单请求</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">凡是不同时满足CORS简单请求条件，就属于非简单请求。</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">两种请求的区别：</span><br><span class="line">	简单请求：一次请求</span><br><span class="line">	非简单请求：两次请求，在发送数据之前会先发一次请求用于做“预检”，只有“预检”通过后才再发送一次请求用于数据传输。</span><br><span class="line">	关于“预检”</span><br><span class="line"></span><br><span class="line">- 请求方式：OPTIONS</span><br><span class="line">- “预检”其实做检查，检查如果通过则允许传输数据，检查不通过则不再发送真正想要发送的消息</span><br><span class="line">- 如何“预检”</span><br><span class="line">     =&gt; 如果复杂请求是PUT等请求，则服务端需要设置允许某请求，否则“预检”不通过</span><br><span class="line">        Access-Control-Request-Method</span><br><span class="line">     =&gt; 如果复杂请求设置了请求头，则服务端需要设置允许某请求头，否则“预检”不通过</span><br><span class="line">        Access-Control-Request-Headers</span><br></pre></td></tr></table></figure>
<ul>
<li>Django项目支持CORS</li>
</ul>
<p>① 在返回的结果中加入允许信息（简单请求） </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">test</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">import</span> json</span><br><span class="line">    obj=HttpResponse(json.dumps(&#123;<span class="string">'name'</span>:<span class="string">'lqz'</span>&#125;))</span><br><span class="line">    <span class="comment"># obj['Access-Control-Allow-Origin']='*'</span></span><br><span class="line">    obj[<span class="string">'Access-Control-Allow-Origin'</span>]=<span class="string">'http://127.0.0.1:8004'</span></span><br><span class="line">    <span class="keyword">return</span> obj</span><br></pre></td></tr></table></figure>
<p>② 放到中间件处理复杂和简单请求 </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CorsMiddleWare</span><span class="params">(MiddlewareMixin)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self,request,response)</span>:</span></span><br><span class="line">        <span class="keyword">if</span> request.method==<span class="string">"OPTIONS"</span>:</span><br><span class="line">            response[<span class="string">"Access-Control-Allow-Headers"</span>]=<span class="string">"Content-Type"</span></span><br><span class="line">        response[<span class="string">"Access-Control-Allow-Origin"</span>] = <span class="string">"http://localhost:8080"</span></span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<h1 id="十一、Django中使用Redis"><a href="#十一、Django中使用Redis" class="headerlink" title="十一、Django中使用Redis"></a>十一、Django中使用Redis</h1><h2 id="方式一"><a href="#方式一" class="headerlink" title="方式一"></a>方式一</h2><p>①新建utils文件夹，并在该文件夹下建立redis_pool.py </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line">POOL = redis.ConnectionPool(host=<span class="string">'127.0.0.1'</span>, port=<span class="number">6379</span>,password=<span class="string">'1234'</span>,max_connections=<span class="number">1000</span>)</span><br></pre></td></tr></table></figure>
<p>②视图函数中使用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> redis</span><br><span class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> render,HttpResponse</span><br><span class="line"><span class="keyword">from</span> utils.redis_pool <span class="keyword">import</span> POOL</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">    conn = redis.Redis(connection_pool=POOL)</span><br><span class="line">    conn.hset(<span class="string">'kkk'</span>,<span class="string">'age'</span>,<span class="number">18</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'设置成功'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">order</span><span class="params">(request)</span>:</span></span><br><span class="line">    conn = redis.Redis(connection_pool=POOL)</span><br><span class="line">    conn.hget(<span class="string">'kkk'</span>,<span class="string">'age'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">'获取成功'</span>)</span><br></pre></td></tr></table></figure>
<h2 id="方式二"><a href="#方式二" class="headerlink" title="方式二"></a>方式二</h2><p>①安装django-redis</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install django-redis</span><br></pre></td></tr></table></figure>
<p>②setting里配置： </p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis配置</span></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">"default"</span>: &#123;</span><br><span class="line">        <span class="string">"BACKEND"</span>: <span class="string">"django_redis.cache.RedisCache"</span>,</span><br><span class="line">        <span class="string">"LOCATION"</span>: <span class="string">"redis://127.0.0.1:6379"</span>,</span><br><span class="line">        <span class="string">"OPTIONS"</span>: &#123;</span><br><span class="line">            <span class="string">"CLIENT_CLASS"</span>: <span class="string">"django_redis.client.DefaultClient"</span>,</span><br><span class="line">            <span class="string">"CONNECTION_POOL_KWARGS"</span>: &#123;<span class="string">"max_connections"</span>: <span class="number">100</span>&#125;</span><br><span class="line">            <span class="comment"># "PASSWORD": "123",</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>③视图函数</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django_redis <span class="keyword">import</span> get_redis_connection</span><br><span class="line">conn = get_redis_connection(<span class="string">'default'</span>)</span><br><span class="line">print(conn.hgetall(<span class="string">'xxx'</span>))</span><br></pre></td></tr></table></figure>
<h1 id="十二、Django缓存机制"><a href="#十二、Django缓存机制" class="headerlink" title="十二、Django缓存机制"></a>十二、Django缓存机制</h1><h2 id="1-三个粒度"><a href="#1-三个粒度" class="headerlink" title="1.三个粒度"></a>1.三个粒度</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> 全站缓存</span><br><span class="line">	用中间件：</span><br><span class="line">	MIDDLEWARE = [</span><br><span class="line">		<span class="comment"># 'django.middleware.cache.UpdateCacheMiddleware',</span></span><br><span class="line">		<span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line">		...</span><br><span class="line">		<span class="comment"># 'django.middleware.cache.FetchFromCacheMiddleware'</span></span><br><span class="line"></span><br><span class="line">		]</span><br><span class="line">	<span class="comment"># CACHE_MIDDLEWARE_SECONDS=10</span></span><br><span class="line"><span class="number">2</span> 单视图：</span><br><span class="line">	用装饰器</span><br><span class="line">	<span class="keyword">from</span> django.views.decorators.cache <span class="keyword">import</span> cache_page</span><br><span class="line"><span class="meta">	@cache_page(24*60*60)</span></span><br><span class="line">       <span class="function"><span class="keyword">def</span> <span class="title">index</span><span class="params">(request)</span>:</span></span><br><span class="line">           <span class="keyword">pass</span></span><br><span class="line"><span class="number">3</span> 局部页面：</span><br><span class="line">	&#123;% load cache %&#125;</span><br><span class="line">	&#123;% cache <span class="number">5</span> <span class="string">'test'</span> %&#125;   两个参数：时间，唯一标识</span><br><span class="line">	&#123;&#123; ctime &#125;&#125;</span><br><span class="line">	&#123;% endcache %&#125;</span><br></pre></td></tr></table></figure>

        </div>

        <section class="meta">
            <time class="time" itemprop="dateUpdated" datetime="2018-12-02T00:31:32+08:00" content="2018-12-02">
                <i class="fas fa-pen fa-fw" aria-hidden="true"></i>
                本文最后更新于：2018-12-02
            </time>
            
                
                <div class="tags">
                    <i class="fas fa-tags fa-fw" aria-hidden="true"></i>
                    <a class="tag" href="/tags/Django/">Django</a>, <a class="tag" href="/tags/MTV/">MTV</a>
                </div>
            
        </section>

        
            <div class="prev-next">
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>下一篇&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/2018/12/02/hello-world/" rel="prev" title="Hello World">
                                    
                                        Hello World
                                    
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <i class="fas fa-tags fa-fw" aria-hidden="true"></i>
                                    <a class="tag" href="/tags/HTML/">HTML</a>, <a class="tag" href="/tags/CSS/">CSS</a>
                                </h6>
                            
                        </span>
                    </section>
                
            </div>
        

    </section>

</article>

<br>

<!-- 显示推荐文章和评论 -->

    <article class="post white-box comments">
        <section class="article typo">

            
                

    <div class="recommended_posts">
        <h4><i class="fas fa-bookmark fa-fw" aria-hidden="true"></i>&nbsp;你可能感兴趣的文章</h4>
        <ul>
            
                <li><a href="http://yoursite.com/2018/12/02/hello-world/">Hello World</a></li>
            
        </ul>
    </div>


            

            

                

                

                
            

        </section>
    </article>


<script>
    window.subData = {
        title: 'Django介绍',
        tools: true
    }
</script>


        </div>
        <aside class='l_side'>
            
    
        
  <section class="m_widget author">
    
      <div class="header">
        <img class="avatar" src="https://xaoxuu.com/assets/img/avatar.jpg">
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="mailto:zhuohfeng@163.com" class="social flat-box" target="_blank" rel="external"><i class="social fas fa-envelope" aria-hidden="true"></i></a>
          
        
          
            <a href="https://github.com/smart1san" class="social flat-box" target="_blank" rel="external"><i class="social fab fa-github" aria-hidden="true"></i></a>
          
        
          
            <a href="https://music.163.com/#/user/home?id=438614298" class="social flat-box" target="_blank" rel="external"><i class="social fas fa-music" aria-hidden="true"></i></a>
          
        
      </div>
    
  </section>


    
    
        
  <section class="m_widget announcement">
    <header class="header pure">
        <div><i class="fas fa-bullhorn fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;公告</div>
    </header>
    <div class="content pure">
      本站欢迎各位的到来
    </div>
  </section>


    
    
        <section class="m_widget categories">
    <header class="header pure">
        <div><i class="fas fa-folder-open fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;分类</div>
    </header>
    <div class="content pure">
        
            <ul class="entry">
                
                    <li><a class="flat-box" href="/categories/Django/"><div class="name">Django</div><div class="badge">1</div></a></li>
                
            </ul>
        
    </div>
</section>

    
    
        
    <section class="m_widget tagcloud">
        <header class="header pure">
            <div><i class="fas fa-tags fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;标签</div>
        </header>
        <div class="content pure">
            <a href="/tags/CSS/" style="font-size: 14px; color: #999">CSS</a> <a href="/tags/Django/" style="font-size: 14px; color: #999">Django</a> <a href="/tags/HTML/" style="font-size: 14px; color: #999">HTML</a> <a href="/tags/MTV/" style="font-size: 14px; color: #999">MTV</a>
        </div>
    </section>


    
    
        
    <section class="m_widget toc-wrapper">
        <header class="header pure">
            <div><i class="fas fa-list fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;目录</div>
            <div class="wrapper"><a class="s-toc rightBtn" title="固定到顶部" target="_blank" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div>
        </header>
        <div class="content pure">
            <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#一、Django-简介"><span class="toc-text">一、Django 简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Http-协议特性"><span class="toc-text">1.Http 协议特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-MVC和MTV"><span class="toc-text">2.MVC和MTV</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#①-MVC"><span class="toc-text">① MVC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#②-MTV"><span class="toc-text">② MTV</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-Django请求生命周期"><span class="toc-text">3.Django请求生命周期</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#二、路由"><span class="toc-text">二、路由</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-定义"><span class="toc-text">1.定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-简单路由配置"><span class="toc-text">2.简单路由配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-有名分组"><span class="toc-text">3.有名分组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-无名分组"><span class="toc-text">4. 无名分组</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-路由分发"><span class="toc-text">5.路由分发</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-路由反向解析"><span class="toc-text">6.路由反向解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-名称空间"><span class="toc-text">7.名称空间</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-Django-2-版的path"><span class="toc-text">8.Django 2.+版的path</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#三、视图"><span class="toc-text">三、视图</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-三剑客"><span class="toc-text">1.三剑客</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-HttpRequest对象"><span class="toc-text">2. HttpRequest对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-HttpResponse-对象"><span class="toc-text">3.HttpResponse 对象</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-JsonResponse"><span class="toc-text">4.JsonResponse</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-CBV和FBV"><span class="toc-text">5.CBV和FBV</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-简单文件上传"><span class="toc-text">6.简单文件上传</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#四、模板"><span class="toc-text">四、模板</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-template-html"><span class="toc-text">1.template.html</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-过滤器"><span class="toc-text">2.过滤器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-标签"><span class="toc-text">3.标签</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-自定义templatetags"><span class="toc-text">4.自定义templatetags</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-模板导入和继承"><span class="toc-text">5.模板导入和继承</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-静态文件相关"><span class="toc-text">6.静态文件相关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-inclusion-tag"><span class="toc-text">7.inclusion_tag</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#五、模型-models-py"><span class="toc-text">五、模型(models.py)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#添加表记录"><span class="toc-text">添加表记录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#跨表查询"><span class="toc-text">跨表查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#双下滑下跨表查询"><span class="toc-text">双下滑下跨表查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#聚合查询和分组查询"><span class="toc-text">聚合查询和分组查询</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#F查询和Q查询"><span class="toc-text">F查询和Q查询</span></a></li></ol></li></ol><li class="toc-item toc-level-1"><a class="toc-link" href="#六、组件"><span class="toc-text">六、组件</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-Ajax"><span class="toc-text">1.Ajax</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-分页器"><span class="toc-text">2.分页器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-forms组件"><span class="toc-text">3.forms组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-cookie和session"><span class="toc-text">4.cookie和session</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-中间件"><span class="toc-text">5.中间件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#CSRF-TOKEN跨站请求伪造"><span class="toc-text">CSRF_TOKEN跨站请求伪造</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#6-Auth模块（Django自带的用户认证模块）"><span class="toc-text">6.Auth模块（Django自带的用户认证模块）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#authenticate"><span class="toc-text">authenticate()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#login-HttpRequest-user"><span class="toc-text">login(HttpRequest, user)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logout-request"><span class="toc-text">logout(request)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#is-authenticated"><span class="toc-text">is_authenticated()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#login-requierd"><span class="toc-text">login_requierd()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-user"><span class="toc-text">create_user()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#create-superuser"><span class="toc-text">create_superuser()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#check-password-password"><span class="toc-text">check_password(password)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#set-password-password"><span class="toc-text">set_password(password)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#User对象的属性"><span class="toc-text">User对象的属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#扩展auth-user表"><span class="toc-text">扩展auth_user表</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-ContentType（Django提供的ContentType表-）"><span class="toc-text">7.ContentType（Django提供的ContentType表 ）</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#七、Rest-Framework"><span class="toc-text">七、Rest Framework</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-RESTful规范"><span class="toc-text">1.RESTful规范</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-APIView"><span class="toc-text">2.APIView</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-序列化组件"><span class="toc-text">3.序列化组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#source"><span class="toc-text">source</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-视图组件"><span class="toc-text">4.视图组件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#5-解析器、认证组件、频率组件、权限组件"><span class="toc-text">5.解析器、认证组件、频率组件、权限组件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#5-1-解析器"><span class="toc-text">5.1 解析器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-2-认证组件"><span class="toc-text">5.2 认证组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#token认证：存数据库的—-gt-Redis—-gt-不存数据库的认证"><span class="toc-text">token认证：存数据库的—&gt;Redis—&gt;不存数据库的认证</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#源码分析"><span class="toc-text">源码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-2-频率组件"><span class="toc-text">6.2 频率组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#源码分析-1"><span class="toc-text">源码分析</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6-3-权限组件"><span class="toc-text">6.3 权限组件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#7-分页器"><span class="toc-text">7.分页器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#8-响应器（渲染器）"><span class="toc-text">8.响应器（渲染器）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#9-URL控制器"><span class="toc-text">9.URL控制器</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#10-版本控制"><span class="toc-text">10.版本控制</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#源码分析-2"><span class="toc-text">源码分析</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#八、settings-py配置"><span class="toc-text">八、settings.py配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-APPEND-SLASH"><span class="toc-text">1.APPEND_SLASH</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-static（css文件，js文件，图片文件-）"><span class="toc-text">2.static（css文件，js文件，图片文件 ）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-数据库配置"><span class="toc-text">3 数据库配置</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#九、创建Django"><span class="toc-text">九、创建Django</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十、跨域请求（同源策略）"><span class="toc-text">十、跨域请求（同源策略）</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十一、Django中使用Redis"><span class="toc-text">十一、Django中使用Redis</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#方式一"><span class="toc-text">方式一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#方式二"><span class="toc-text">方式二</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#十二、Django缓存机制"><span class="toc-text">十二、Django缓存机制</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-三个粒度"><span class="toc-text">1.三个粒度</span></a></li></ol></li>
        </div>
    </section>


    
    
        <section class="m_widget music">
    <header class="header pure">
        <div><i class="fas fa-headphones-alt fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;音乐</div>
        <a class="rightBtn" title="打开博主的网易云音乐主页" target="_blank" rel="external nofollow noopener noreferrer" href="https://music.163.com/#/playlist?id=746319661"><i class="fas fa-external-link-square-alt fa-fw"></i></a>
    </header>
    <div class="content pure">
        <iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width="100%" height="450" src="//music.163.com/outchain/player?type=0&id=746319661&auto=0&height=450"></iframe>
    </div>
</section>

    
    
        <section class="m_widget links">
    <header class="header pure">
        <div><i class="fas fa-handshake fa-fw" aria-hidden="true"></i>&nbsp;&nbsp;友链</div>
        
            <a class="rightBtn" title="联系博主添加友链" target="_blank" rel="external nofollow noopener noreferrer" href="mailto:me@xaoxuu.com?subject=交换友链&body=你好，我想和你交换友链，我已经将【VIP】添加到我的博客的友链中。我的博客链接是："><i class="fas fa-plus fa-fw"></i></a>
        
    </header>
    <div class="content pure">
        <ul class="entry" id="links">
            
                <li><a class="flat-box" title="https://xaoxuu.com/blog" target="_blank" rel="external nofollow noopener noreferrer" href="https://xaoxuu.com/blog">
                    <div class="name">
                        
                            <img src="https://xaoxuu.com/assets/img/avatar.jpg">
                        
                        &nbsp;&nbsp;xaoxuu&#39;s blog
                    </div>
                </a></li>
            
        </ul>
    </div>
</section>

    


        </aside>
        <script>setLoadingBarProgress(60);</script>
    </div>
    </div>
    <footer id="footer" class="clearfix">
    
        <div class="social-wrapper">
          
              
                  <a href="mailto:zhuohfeng@163.com" class="social fas fa-envelope flat-box" target="_blank" rel="external"></a>
              
          
              
                  <a href="https://github.com/smart1san" class="social fab fa-github flat-box" target="_blank" rel="external"></a>
              
          
              
                  <a href="https://music.163.com/#/user/home?id=438614298" class="social fas fa-music flat-box" target="_blank" rel="external"></a>
              
          
        </div>
    
    <br>
    <div>博客内容遵循 <a target="_blank" href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" class="licenses">知识共享 署名 - 非商业性 - 相同方式共享 4.0 国际协议</a></div>
    <div>本站使用 <a href="https://xaoxuu.com/wiki/material-x/" target="_blank" class="codename">Material X</a> 作为主题，
		总访问量为 <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span> 次。
    </div>
</footer>
<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->


    <script>setLoadingBarProgress(80);</script>
    <script src="//apps.bdimg.com/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="//cdn.bootcss.com/node-waves/0.7.5/waves.min.js"></script>
<script src="//cdn.bootcss.com/scrollReveal.js/3.3.2/scrollreveal.min.js"></script>
<!-- 访问统计 -->
<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>


<script src="/js/jquery.fitvids.js"></script>

    <script>
        var GOOGLE_CUSTOM_SEARCH_API_KEY = "";
        var GOOGLE_CUSTOM_SEARCH_ENGINE_ID = "";
        var ALGOLIA_API_KEY = "";
        var ALGOLIA_APP_ID = "";
        var ALGOLIA_INDEX_NAME = "";
        var AZURE_SERVICE_NAME = "";
        var AZURE_INDEX_NAME = "";
        var AZURE_QUERY_KEY = "";
        var BAIDU_API_ID = "";
        var SEARCH_SERVICE = "hexo" || "hexo";
        var ROOT = "/"||"/";
        if(!ROOT.endsWith('/'))ROOT += '/';
    </script>

<script src="/js/search.js"></script>
<script src="/js/app.js"></script>


    
    
    




  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
  <script>AV.initialize("", "");</script>
  <script>
  function showTime(Counter) {
    var query = new AV.Query(Counter);
    var entries = [];
    var $visitors = $(".leancloud_visitors");

    $visitors.each(function () {
      entries.push( $(this).attr("id").trim() );
    });

    query.containedIn('url', entries);
    query.find()
      .done(function (results) {
        var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

        if (results.length === 0) {
          $visitors.find(COUNT_CONTAINER_REF).text(0);
          return;
        }

        for (var i = 0; i < results.length; i++) {
          var item = results[i];
          var url = item.get('url');
          var time = item.get('time');
          var element = document.getElementById(url);

          $(element).find(COUNT_CONTAINER_REF).text(time);
        }
        for(var i = 0; i < entries.length; i++) {
          var url = entries[i];
          var element = document.getElementById(url);
          var countSpan = $(element).find(COUNT_CONTAINER_REF);
          if( countSpan.text() == '') {
            countSpan.text(0);
          }
        }
      })
      .fail(function (object, error) {
        console.log("Error: " + error.code + " " + error.message);
      });
  }

  function addCount(Counter) {
    var $visitors = $(".leancloud_visitors");
    var url = $visitors.attr('id').trim();
    var title = $visitors.attr('data-flag-title').trim();
    var query = new AV.Query(Counter);

    query.equalTo("url", url);
    query.find({
      success: function(results) {
        if (results.length > 0) {
          var counter = results[0];
          counter.fetchWhenSave(true);
          counter.increment("time");
          counter.save(null, {
            success: function(counter) {
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(counter.get('time'));
            },
            error: function(counter, error) {
              console.log('Failed to save Visitor num, with error message: ' + error.message);
            }
          });
        } else {
          var newcounter = new Counter();
          /* Set ACL */
          var acl = new AV.ACL();
          acl.setPublicReadAccess(true);
          acl.setPublicWriteAccess(true);
          newcounter.setACL(acl);
          /* End Set ACL */
          newcounter.set("title", title);
          newcounter.set("url", url);
          newcounter.set("time", 1);
          newcounter.save(null, {
            success: function(newcounter) {
              var $element = $(document.getElementById(url));
              $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
            },
            error: function(newcounter, error) {
              console.log('Failed to create');
            }
          });
        }
      },
      error: function(error) {
        console.log('Error:' + error.code + " " + error.message);
      }
    });
  }

  $(function() {
    var Counter = AV.Object.extend("Counter");
    if ($('.leancloud_visitors').length == 1) {
      addCount(Counter);
    } else if ($('.post-title-link').length > 1) {
      showTime(Counter);
    }
  });
</script>


    <script>setLoadingBarProgress(100);</script>
</body>
